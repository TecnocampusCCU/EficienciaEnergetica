# -*- coding: utf-8 -*-
"""
/***************************************************************************
 EficEnerg
                                 A QGIS plugin
 efic energ
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2023-05-23
        git sha              : $Format:%H$
        copyright            : (C) 2023 by Miquel Rodriguez
        email                : mrodriguezj@edu.tecnocampus.cat
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   Per implementar encara [TODO] :                                       *
 *   - Al finalitzar tot, escriure un manual d'usuari del plugin.          *
 *                                                                         *
 ***************************************************************************/
 
"""


import collections
import datetime
import os
import os.path
import sys
import time
import unicodedata
from os.path import expanduser

import processing
import psycopg2
import qgis.utils
from PyQt5.QtCore import *
from PyQt5.QtCore import QSizeF
from PyQt5.QtGui import *
from PyQt5.QtGui import QColor
from PyQt5.QtSql import *
from PyQt5.QtWidgets import QAction, QApplication, QMessageBox,QToolBar
from qgis.core import (QgsCategorizedSymbolRenderer,
                       QgsCoordinateReferenceSystem, QgsDataSourceUri,
                       QgsDiagramLayerSettings, QgsDiagramSettings,
                       QgsPalLayerSettings, QgsPieDiagram, QgsProject,
                       QgsProperty, QgsPropertyCollection, QgsRendererCategory,
                       QgsSimpleFillSymbolLayer, QgsSimpleLineSymbolLayer,
                       QgsSingleCategoryDiagramRenderer, QgsSymbol,
                       QgsTextBackgroundSettings, QgsTextFormat, QgsUnitTypes,
                       QgsVectorLayer, QgsVectorLayerExporter,
                       QgsVectorLayerSimpleLabeling, QgsWkbTypes)
from qgis.PyQt.QtCore import QCoreApplication, QSettings, QTranslator
from qgis.PyQt.QtGui import QIcon
from qgis.PyQt.QtWidgets import QAction, QApplication, QMessageBox
from qgis.utils import iface

# Import the code for the dialog
from .eficiencia_energetica_dialog import EficEnergDialog
# Initialize Qt resources from file resources.py
from .resources import *

'''Varibles globals'''
Versio_modul = "V_Q3.230920"
nomBD1 = ""
password1 = ""
host1 = ""
port1 = ""
user1 = ""
cur = None
conn = None
progress = None
textBox = ""
uri = None
numOperacions = 0
numEntitats = 0
fitxer = ""

habitatges = "cert_efi_energ_edif_mataro_geom"
habitatgesLayer = None
entitat = None
entitatLayer = None
entitatLayerJoined = None
entitatLayerResumNumHabit = None
entitatLayerResumm2 = None
entitatLayerResumMitjana = None
entitatLayerResumModa = None
entitatLayerResumMediana = None

llistaEntitats = [
    None, # Entitat per defecte, ha de donar error
    "parcel",
    "ILLES",
    "Seccions",
    "Barris",
    "DistrictesPostals",
    "Districtes"
]

class EficEnerg:
    """QGIS Plugin Implementation."""

    def __init__(self, iface):
        """Constructor.

        :param iface: An interface instance that will be passed to this class
            which provides the hook by which you can manipulate the QGIS
            application at run time.
        :type iface: QgsInterface
        """
        # Save reference to the QGIS interface
        self.iface = iface
        # initialize plugin directory
        self.plugin_dir = os.path.dirname(__file__)
        # initialize locale
        locale = QSettings().value('locale/userLocale')[0:2]
        locale_path = os.path.join(
            self.plugin_dir,
            'i18n',
            'EficEnerg_{}.qm'.format(locale))

        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            if qVersion() > '4.3.3':
                QCoreApplication.installTranslator(self.translator)

        # Create the dialog and keep reference

        self.dlg = EficEnergDialog()
        
        self.dlg.pushSortir.clicked.connect(self.on_click_Sortir)
        self.dlg.pushInici.clicked.connect(self.on_click_Inici)
        self.dlg.comboBD.currentIndexChanged.connect(self.on_change_ComboConn)
        self.dlg.comboEntitat.currentIndexChanged.connect(self.on_change_comboEntitat)
        self.dlg.checkNumHabit.stateChanged.connect(self.on_change_checkNumHabit)
        self.dlg.checkm2.stateChanged.connect(self.on_change_checkm2)
        self.dlg.checkMitjana.stateChanged.connect(self.on_change_checkMitjana)
        self.dlg.checkModa.stateChanged.connect(self.on_change_checkModa)
        self.dlg.checkMediana.stateChanged.connect(self.on_change_checkMediana)

        self.dlg.checkNumHabit.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkm2.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkMitjana.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkModa.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkMediana.stateChanged.connect(self.on_change_entitatsIOperacions)

        # Declare instance attributes
        self.actions = []
        self.menu = self.tr(u'&CCU')
        trobat=False
        for x in iface.mainWindow().findChildren(QToolBar,'CCU'): 
            self.toolbar = x
            trobat=True
        
        if not trobat:
            self.toolbar = self.iface.addToolBar('CCU')
            self.toolbar.setObjectName('CCU')
    # noinspection PyMethodMayBeStatic
    def tr(self, message):
        """Get the translation for a string using Qt translation API.

        We implement this ourselves since we do not inherit QObject.

        :param message: String for translation.
        :type message: str, QString

        :returns: Translated version of message.
        :rtype: QString
        """
        # noinspection PyTypeChecker,PyArgumentList,PyCallByClass
        return QCoreApplication.translate('EficEnerg', message)

    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None):
        """Add a toolbar icon to the toolbar.

        :param icon_path: Path to the icon for this action. Can be a resource
            path (e.g. ':/plugins/foo/bar.png') or a normal file system path.
        :type icon_path: str

        :param text: Text that should be shown in menu items for this action.
        :type text: str

        :param callback: Function to be called when the action is triggered.
        :type callback: function

        :param enabled_flag: A flag indicating if the action should be enabled
            by default. Defaults to True.
        :type enabled_flag: bool

        :param add_to_menu: Flag indicating whether the action should also
            be added to the menu. Defaults to True.
        :type add_to_menu: bool

        :param add_to_toolbar: Flag indicating whether the action should also
            be added to the toolbar. Defaults to True.
        :type add_to_toolbar: bool

        :param status_tip: Optional text to show in a popup when mouse pointer
            hovers over the action.
        :type status_tip: str

        :param parent: Parent widget for the new action. Defaults None.
        :type parent: QWidget

        :param whats_this: Optional text to show in the status bar when the
            mouse pointer hovers over the action.

        :returns: The action that was created. Note that the action is also
            added to self.actions list.
        :rtype: QAction
        """

        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip is not None:
            action.setStatusTip(status_tip)

        if whats_this is not None:
            action.setWhatsThis(whats_this)

        if add_to_toolbar:
            # Adds plugin icon to Plugins toolbar
            self.toolbar.addAction(action)

        if add_to_menu:
            self.iface.addPluginToMenu(
                self.menu,
                action)

        self.actions.append(action)

        return action

    def initGui(self):
        """Create the menu entries and toolbar icons inside the QGIS GUI."""

        icon_path = ':/plugins/eficiencia_energetica/icon.png'
        self.add_action(
            icon_path,
            text=self.tr(u'Eficiencia Energetica'),
            callback=self.run,
            parent=self.iface.mainWindow())

        # will be set False in run()
        self.first_start = True

    def on_change_ComboConn(self):
        global nomBD1
        global password1
        global host1
        global port1
        global user1
        global cur
        global conn
        global textBox
        global uri
        s = QSettings()
        select = 'Selecciona connexi√≥'
        nom_conn = self.dlg.comboBD.currentText()

        if nom_conn != select:
            s.beginGroup("PostgreSQL/connections/"+nom_conn)
            currentKeys = s.childKeys()

            nomBD1 = s.value("database", "")
            password1 = s.value("password", "")
            host1 = s.value("host", "")
            port1 = s.value("port", "")
            user1 = s.value("username", "")
            #schema1 = s.value("schema", "")

            self.barraEstat_connectant()
            textBox += f"\nConnectant a la base de dades {nomBD1}...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.dlg.lblEstatConn.setAutoFillBackground(True)
            QApplication.processEvents()

            # Connexio
            nomBD = nomBD1.encode('ascii', 'ignore')
            user = user1.encode('ascii', 'ignore')
            server = host1.encode('ascii', 'ignore')
            password = password1.encode('ascii', 'ignore')
            #schema = schema1.encode('ascii', 'ignore')
            try:
                estructura = "dbname='"+ nomBD.decode("utf-8") + "' user='" + user.decode("utf-8") +"' host='" + server.decode("utf-8") +"' password='" + password.decode("utf-8") + "'" # + "'schema='" + schema.decode("utf-8") + "'"
                conn = psycopg2.connect(estructura)
                self.barraEstat_connectat()
                textBox += f"\nConnectat a la base de dades {nomBD1}\n"
                textBox += "\nSelecciona les entitats amb les que vulguis treballar i indica amb quines entitats treballar√†s aix√≠ com els camps que vols calcular i inicia el proc√©s"
                self.dlg.textEstat.setText(textBox)
                self.scroll_text()
                cur = conn.cursor()
                uri = QgsDataSourceUri()
                uri.setConnection(host1, port1, nomBD1, user1, password1)
                #schema1 = "public"

                self.dlg.groupEntitats.setEnabled(True)
                self.dlg.comboEntitat.setEnabled(True)
                self.dlg.groupChecks.setEnabled(True)
                self.dlg.pushInici.setEnabled(True)

                self.dlg.groupEntitats.setVisible(True)
                self.dlg.comboEntitat.setVisible(True)
                self.dlg.groupChecks.setVisible(True)

            except Exception as ex:
                self.estatInicial()
                print ("I am unable to connect to the database")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error canvi connexi√≥")
                if conn is not None:
                    conn.rollback()
                self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #ff7f7f')
                self.dlg.lblEstatConn.setText('Error: Hi ha algun camp erroni.')
                return
             
        else:
            self.barraEstat_noConnectat()
    
    def on_change_comboEntitat(self):
        global uri
        global schema1
        global entitat
        global entitatLayer
        global llistaEntitats
        entitat = llistaEntitats[self.dlg.comboEntitat.currentIndex()]
        schema1 = "public"
        try:
            uri.setDataSource(schema1, entitat, 'geom')
            entitatLayer = QgsVectorLayer(uri.uri(), entitat, 'postgres')
        except Exception as ex:
            print ("Error no s'ha trobat entitat")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error no s'ha trobat entitat")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
    def on_change_entitatsIOperacions(self):
        if numOperacions > 2:
            self.dlg.labelAvis.setVisible(True)
        else:
            self.dlg.labelAvis.setVisible(False)

    def on_change_checkNumHabit(self):
        global numOperacions

        if self.dlg.checkm2.isChecked() or self.dlg.checkNumHabit.isChecked():
            self.dlg.checkMitjana.setEnabled(True)
            self.dlg.checkModa.setEnabled(True)
            self.dlg.checkMediana.setEnabled(True)

        if not self.dlg.checkm2.isChecked() and not self.dlg.checkNumHabit.isChecked():
            self.dlg.checkModa.setEnabled(False)
            self.dlg.checkModa.setChecked(False)
            self.dlg.checkMitjana.setEnabled(False)
            self.dlg.checkMitjana.setChecked(False)
            self.dlg.checkMediana.setEnabled(False)
            self.dlg.checkMediana.setChecked(False)

        if self.dlg.checkNumHabit.isChecked() and self.dlg.checkm2.isChecked():
            self.dlg.labelRestriccio.setVisible(True)
        else:
            self.dlg.labelRestriccio.setVisible(False)

        if self.dlg.checkNumHabit.isChecked():
            numOperacions += 1
        if not self.dlg.checkNumHabit.isChecked():
            numOperacions -= 1

    def on_change_checkm2(self):
        global numOperacions

        if self.dlg.checkm2.isChecked() or self.dlg.checkNumHabit.isChecked():
            self.dlg.checkMitjana.setEnabled(True)
            self.dlg.checkModa.setEnabled(True)
            self.dlg.checkMediana.setEnabled(True)

        if not self.dlg.checkm2.isChecked() and not self.dlg.checkNumHabit.isChecked():
            self.dlg.checkModa.setEnabled(False)
            self.dlg.checkModa.setChecked(False)
            self.dlg.checkMitjana.setEnabled(False)
            self.dlg.checkMitjana.setChecked(False)
            self.dlg.checkMediana.setEnabled(False)
            self.dlg.checkMediana.setChecked(False)
        
        if self.dlg.checkNumHabit.isChecked() and self.dlg.checkm2.isChecked():
            self.dlg.labelRestriccio.setVisible(True)
        else:
            self.dlg.labelRestriccio.setVisible(False)

        if self.dlg.checkm2.isChecked():
            numOperacions += 1
        if not self.dlg.checkm2.isChecked():
            numOperacions -= 1
    
    def on_change_checkMitjana(self):
        global numOperacions
        if self.dlg.checkMitjana.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def on_change_checkModa(self):
        global numOperacions
        if self.dlg.checkModa.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def on_change_checkMediana(self):
        global numOperacions
        if self.dlg.checkMediana.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def ompleCombos(self, combo, llista, predef, sort):
        combo.blockSignals(True)
        combo.clear()
        model=QStandardItemModel(combo)
        predefInList=None
        for elem in llista:
            try:
                if isinstance(elem, tuple):
                    item = QStandardItem(unicode(elem[0]))
                else:
                    item = QStandardItem(str(elem))
            except TypeError:
                item = QStandardItem(str(elem[0]))
            model.appendRow(item)
            if elem == predef:
                predefInList = elem
        combo.setModel(model)
        if predef != "":
            if predefInList:
                combo.setCurrentIndex(combo.findText(predefInList))
            else:
                combo.insertItem(0, predef)
                combo.setCurrentIndex(0)
        combo.blockSignals(False)

    def getConnections(self):
        '''Aquesta funci√≥ retorna les connexions que estan guardades en el projecte.'''
        s = QSettings()
        s.beginGroup("PostgreSQL/connections")
        currentConnections = s.childGroups()
        s.endGroup()
        return currentConnections

    def estatInicial(self):
        global textBox
        global Versio_modul
        self.dlg.comboBD.setCurrentIndex(0)
        self.dlg.comboEntitat.setCurrentIndex(0)
        self.barraEstat_noConnectat()
        self.dlg.comboBD.setEnabled(True)
        self.dlg.comboEntitat.setEnabled(False)
        self.dlg.checkNumHabit.setChecked(False)
        self.dlg.checkm2.setChecked(False)
        self.dlg.checkMitjana.setChecked(False)
        self.dlg.checkModa.setChecked(False)
        self.dlg.checkMediana.setChecked(False)
        self.dlg.textEstat.clear()
        self.dlg.versio.setText(Versio_modul)
        self.dlg.groupEntitats.setEnabled(False)
        self.dlg.groupChecks.setEnabled(False)
        self.dlg.pushInici.setEnabled(False)
        self.dlg.groupChecks.setVisible(False)
        self.dlg.groupEntitats.setVisible(False)
        self.dlg.comboEntitat.setVisible(False)
        self.dlg.checkMitjana.setEnabled(False)
        self.dlg.checkModa.setEnabled(False)
        self.dlg.checkMediana.setEnabled(False)
        self.dlg.labelAvis.setVisible(False)
        self.dlg.progressBar.setValue(0)
        self.dlg.labelRestriccio.setVisible(False)
        textBox = "Selecciona una base de dades...\n"
        self.dlg.textEstat.setText(textBox)
        self.dlg.setEnabled(True)
    
    def estatFinalitzat(self):
        self.dlg.comboBD.setEnabled(True)
        self.dlg.comboEntitat.setEnabled(True)
        self.dlg.groupChecks.setEnabled(True)
        self.dlg.pushInici.setEnabled(True)
        self.dlg.pushSortir.setEnabled(True)
        self.dlg.labelAvis.setVisible(True)

    def crearCopiesCapesEntitats(self):
        global habitatgesLayer
        global entitatLayer
        
        try:
            copy_table_name = f"{habitatges}_copy_{fitxer}"
            drop_table_query = f'DROP TABLE IF EXISTS "{copy_table_name}"'
            cur.execute(drop_table_query)
            create_table_query = f'CREATE TABLE "{copy_table_name}" (LIKE "{habitatges}" INCLUDING CONSTRAINTS)'
            cur.execute(create_table_query)
            insert_features_query = f'INSERT INTO "{copy_table_name}" SELECT * FROM "{habitatges}"'
            cur.execute(insert_features_query)
            conn.commit()

            uri.setDataSource(schema1, f"{copy_table_name}", 'geom')
            habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')

            copy_table_name = f"{entitat}_copy_{fitxer}"
            drop_table_query = f'DROP TABLE IF EXISTS "{copy_table_name}"'
            cur.execute(drop_table_query)
            create_table_query = f'CREATE TABLE "{copy_table_name}" (LIKE "{entitat}" INCLUDING CONSTRAINTS)'
            cur.execute(create_table_query)
            insert_features_query = f'INSERT INTO "{copy_table_name}" SELECT * FROM "{entitat}"'
            cur.execute(insert_features_query)
            conn.commit()

            uri.setDataSource(schema1, f"{copy_table_name}", 'geom')
            entitatLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')

        except Exception as ex:
            print ("Error a creaci√≥ de capes copia")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes copia")
            conn.rollback()
            return

    def crearIDentitats(self):
        if not entitat==llistaEntitats[1]:
            global habitatgesLayer
            '''Funcio per calcular els ID de les entitats que es combinaran amb els habitatges'''
            try:
                sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" DROP COLUMN IF EXISTS "{entitat}_id";\n'
                cur.execute(sql)
                conn.commit()
                sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" ADD COLUMN "{entitat}_id" INTEGER;\n'
                sql += f'UPDATE "{habitatges}_copy_{fitxer}" SET "{entitat}_id" = "{entitat}_copy_{fitxer}".id FROM "{entitat}_copy_{fitxer}" WHERE ST_Intersects("{habitatges}_copy_{fitxer}".geom, "{entitat}_copy_{fitxer}".geom);'
                cur.execute(sql)
                conn.commit()

                uri.setDataSource(schema1, f"{habitatges}_copy_{fitxer}", 'geom')
                habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{habitatges}_copy_{fitxer}"', 'postgres')
            except Exception as ex:
                print ("Error calculant ID auxiliars entitats")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculant ID auxiliars entitats")
                conn.rollback()
                self.dlg.setEnabled(True)
                return

    def calcularCampsHabitatges(self):
        global habitatges
        global habitatgesLayer

        if entitat==llistaEntitats[1]:
            try:
                sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" DROP COLUMN IF EXISTS "UTM";\n'
                cur.execute(sql)
                conn.commit()

                sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" ADD COLUMN "UTM" VARCHAR;\n'
                sql += f'UPDATE "{habitatges}_copy_{fitxer}" SET "UTM" = LEFT("referencia cadastral", 7);\n'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculant camps auxiliars habitatges (en particular UTM per parcel¬∑les)")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculant camps auxiliars habitatges (en particular UTM per parcel¬∑les)")
                conn.rollback()
                self.dlg.setEnabled(True)
                return

        try:
            sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" DROP COLUMN IF EXISTS "producte_con";\n'
            sql += f'ALTER TABLE "{habitatges}_copy_{fitxer}" DROP COLUMN IF EXISTS "producte_emi";\n'
            cur.execute(sql)
            conn.commit()

            sql = f'ALTER TABLE "{habitatges}_copy_{fitxer}" ADD COLUMN "producte_con" FLOAT;\n'
            sql += f'UPDATE "{habitatges}_copy_{fitxer}" SET "producte_con" = CAST("energia prim√†ria no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT);\n'
            
            sql += f'ALTER TABLE "{habitatges}_copy_{fitxer}" ADD COLUMN "producte_emi" FLOAT;\n'
            sql += f'UPDATE "{habitatges}_copy_{fitxer}" SET "producte_emi" = CAST("emissions de co2" AS FLOAT) * CAST("metres_cadastre" AS FLOAT);'

            cur.execute(sql)
            conn.commit()    

            uri.setDataSource(schema1, f"{habitatges}_copy_{fitxer}", 'geom')
            habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{habitatges}_copy_{fitxer}"', 'postgres')    
        except Exception as ex:
            print ("Error calculant camps auxiliars habitatges")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error calculant camps auxiliars habitatges")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculNumX(self):

        ''' Drop de les columnes en cas d'existir '''
        try:
            drop = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumA";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumB";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumC";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumD";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumE";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumF";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "NumG";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "TotalEE";'
            cur.execute(drop)
            conn.commit()
        except Exception as ex:
            print ("Error dropping NumX columns")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error dropping NumX columns")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
        '''Calcul de les diferents columnes NumA, NumB, ..., NumG i TotalEE'''

        if entitat == llistaEntitats[1]:
            try:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumA" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumA" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'A' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumB" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumB" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'B' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumC" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumC" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'C' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumD" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumD" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'D' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumE" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumE" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'E' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumF" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumF" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'F' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumG" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumG" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'G' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "TotalEE" integer;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "TotalEE" = "NumA" + "NumB" + "NumC" + "NumD" + "NumE" + "NumF" + "NumG";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating NumX columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculating NumX columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
        else:
            try:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumA" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumA" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'A' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumB" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumB" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'B' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumC" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumC" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'C' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumD" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumD" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'D' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumE" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumE" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'E' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumF" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumF" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'F' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "NumG" integer;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "NumG" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'G' THEN 1 ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "TotalEE" integer;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "TotalEE" = "NumA" + "NumB" + "NumC" + "NumD" + "NumE" + "NumF" + "NumG";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating NumX columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculating NumX columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
    
    def calculm2(self):
        '''Drop de les columnes en cas d'existir'''
        try:
            drop = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2A";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2B";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2C";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2D";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2E";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2F";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "m2G";\n'
            drop += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "Totalm2";'
            cur.execute(drop)
            conn.commit()
        except Exception as ex:
            print ("Error dropping m2X columns")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error dropping m2X columns")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
        '''Calcul m2A, m2B, ..., m2G, Totalm2'''
        
        if entitat == llistaEntitats[1]:
            try:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2A" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2A" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'A' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2B" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2B" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'B' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2C" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2C" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'C' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2D" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2D" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'D' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2E" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2E" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'E' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2F" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2F" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'F' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2G" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2G" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'G' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "Totalm2" float;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "Totalm2" = "m2A" + "m2B" + "m2C" + "m2D" + "m2E" + "m2F" + "m2G";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating m2X columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculating m2X columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
        else:
            try:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2A" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2A" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'A' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2B" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2B" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'B' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2C" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2C" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'C' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2D" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2D" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'D' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2E" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2E" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'E' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2F" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2F" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'F' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "m2G" float;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "m2G" = subquery.sum_count FROM (SELECT "id", SUM(CASE WHEN "qualificaci√≥ de consum energia primaria no renovable" = 'G' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "Totalm2" float;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "Totalm2" = "m2A" + "m2B" + "m2C" + "m2D" + "m2E" + "m2F" + "m2G";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating m2X columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.critical(None, "Error", "Error calculating m2X columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return

    def calculMitjana(self):
        try:
            ' Calcul de maxConsum i QualifMaxSup per tal de tenir una qualificaci√≥ energ√®tica amb la que representar amb un color la entitat al mapa '

            if self.dlg.checkNumHabit.isChecked():

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "maxConsum" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("NumA", "NumB", "NumC", "NumD", "NumE", "NumF", "NumG");\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "QualifMaxSup" VARCHAR;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =  
                    CASE 
                        WHEN "maxConsum" = "NumA" THEN 'A' 
                        WHEN "maxConsum" = "NumB" THEN 'B' 
                        WHEN "maxConsum" = "NumC" THEN 'C' 
                        WHEN "maxConsum" = "NumD" THEN 'D' 
                        WHEN "maxConsum" = "NumE" THEN 'E' 
                        WHEN "maxConsum" = "NumF" THEN 'F' 
                        ELSE 'G' 
                    END;
                '''
                cur.execute(sql)
                conn.commit()

            if self.dlg.checkm2.isChecked():

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "maxConsum";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "QualifMaxSup";\n'

                cur.execute(sql)
                conn.commit()

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "maxConsum" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("m2A", "m2B", "m2C", "m2D", "m2E", "m2F", "m2G");\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "QualifMaxSup" VARCHAR;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =  
                    CASE 
                        WHEN "maxConsum" = "m2A" THEN 'A' 
                        WHEN "maxConsum" = "m2B" THEN 'B' 
                        WHEN "maxConsum" = "m2C" THEN 'C' 
                        WHEN "maxConsum" = "m2D" THEN 'D' 
                        WHEN "maxConsum" = "m2E" THEN 'E' 
                        WHEN "maxConsum" = "m2F" THEN 'F' 
                        ELSE 'G' 
                    END;
                '''
                cur.execute(sql)
                conn.commit()

            ''' Sumatoris '''
            if entitat == llistaEntitats[1]:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_product_consums" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_product_consums" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("producte_con" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_product_emissions" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_product_emissions" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("producte_emi" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_m2" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_m2" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("metres_cadastre" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "UTM") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";'
                cur.execute(sql)
                conn.commit()
            else:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_product_consums" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_product_consums" = subquery.sum_count FROM (SELECT "id", SUM(CAST("producte_con" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_product_emissions" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_product_emissions" = subquery.sum_count FROM (SELECT "id", SUM(CAST("producte_emi" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "sum_m2" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "sum_m2" = subquery.sum_count FROM (SELECT "id", SUM(CAST("metres_cadastre" AS FLOAT)) AS sum_count FROM "Capa unida {entitat}_{fitxer}" GROUP BY "id") AS subquery WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";'
                cur.execute(sql)
                conn.commit()
            ''' Crear indexs (que son camps nous a la taula unida) '''
            sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_consum" FLOAT;\n'
            sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "INDEX_consum" = CASE WHEN "sum_m2" = 0 THEN 0 ELSE ("sum_product_consums"/"sum_m2") END;\n'
            sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_emissions" FLOAT;\n'
            sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "INDEX_emissions" = CASE WHEN "sum_m2" = 0 THEN 0 ELSE ("sum_product_emissions"/"sum_m2") END;'
            cur.execute(sql)
            conn.commit()

        except Exception as ex:
            print ("Error fent sumes de camps de la mitjana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error fent sumes de camps de la mitjana")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculModa(self):
        try:
            ''' Moda per metres quadrats de superficie '''

            if self.dlg.checkNumHabit.isChecked():
            
                ''' Moda per nombre d'habitatges '''

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "maxConsum";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "QualifMaxSup";\n'
                cur.execute(sql)
                conn.commit()

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "maxConsum" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("NumA", "NumB", "NumC", "NumD", "NumE", "NumF", "NumG");\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "QualifMaxSup" VARCHAR;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =
                    CASE
                        WHEN "maxConsum" = "NumA" THEN 'A'
                        WHEN "maxConsum" = "NumB" THEN 'B'
                        WHEN "maxConsum" = "NumC" THEN 'C'
                        WHEN "maxConsum" = "NumD" THEN 'D'
                        WHEN "maxConsum" = "NumE" THEN 'E'
                        WHEN "maxConsum" = "NumF" THEN 'F'
                        ELSE 'G'
                    END;
                '''
                cur.execute(sql)
                conn.commit()

                if entitat==llistaEntitats[1]:
                    sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAhab" FLOAT;\n'
                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAhab" = subquery.moda
                    FROM (
                        SELECT "UTM",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN 1
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) AS subquery
                    WHERE c."UTM" = subquery."UTM"\n;
                    '''

                    sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAhabPonderat" FLOAT;\n'

                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c  
                    SET "indexMODAhabPonderat" = subquery.moda
                    FROM (
                        SELECT "UTM",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"    
                                            THEN CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) AS subquery
                    WHERE c."UTM" = subquery."UTM";
                    '''
                else:
                    sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAhab" FLOAT;\n'
                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAhab" = subquery.moda
                    FROM (
                        SELECT "id",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN 1
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "id"
                    ) AS subquery
                    WHERE c."id" = subquery."id"\n;
                    '''

                    sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAhabPonderat" FLOAT;\n'

                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAhabPonderat" = subquery.moda
                    FROM (
                        SELECT "id",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "id"
                    ) AS subquery
                    WHERE c."id" = subquery."id";
                    '''
                    cur.execute(sql)    
                    conn.commit()

            if self.dlg.checkm2.isChecked():

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "maxConsum" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("m2A", "m2B", "m2C", "m2D", "m2E", "m2F", "m2G");\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "QualifMaxSup" VARCHAR;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =  
                    CASE 
                        WHEN "maxConsum" = "m2A" THEN 'A' 
                        WHEN "maxConsum" = "m2B" THEN 'B' 
                        WHEN "maxConsum" = "m2C" THEN 'C' 
                        WHEN "maxConsum" = "m2D" THEN 'D' 
                        WHEN "maxConsum" = "m2E" THEN 'E' 
                        WHEN "maxConsum" = "m2F" THEN 'F' 
                        ELSE 'G' 
                    END;
                '''
                cur.execute(sql)
                conn.commit()

                if entitat==llistaEntitats[1]:
                    sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAsup" FLOAT;\n'
                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAsup" = subquery.moda
                    FROM (
                        SELECT "UTM",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN 1
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) AS subquery
                    WHERE c."UTM" = subquery."UTM"\n;
                    '''

                    sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAsupPonderat" FLOAT;\n'

                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAsupPonderat" = subquery.moda
                    FROM (
                        SELECT "UTM",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda   
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) AS subquery
                    WHERE c."UTM" = subquery."UTM";   
                    '''
                else:
                    sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAsup" FLOAT;\n'
                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAsup" = subquery.moda
                    FROM (
                        SELECT "id",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN 1
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "id"
                    ) AS subquery
                    WHERE c."id" = subquery."id"\n;
                    '''

                    sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "indexMODAsupPonderat" FLOAT;\n'
                    sql += f'''
                    UPDATE "Capa unida {entitat}_{fitxer}" AS c
                    SET "indexMODAsupPonderat" = subquery.moda
                    FROM (
                        SELECT "id",
                            (
                                SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("energia prim√†ria no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END
                                ) / NULLIF(SUM (
                                    CASE
                                        WHEN "qualificaci√≥ de consum energia primaria no renovable" = "QualifMaxSup"
                                            THEN CAST("metres_cadastre" AS FLOAT)
                                        ELSE 0
                                    END), 0
                                )
                            ) AS moda
                        FROM {schema1}."Capa unida {entitat}_{fitxer}"
                        GROUP BY "id"
                    ) AS subquery
                    WHERE c."id" = subquery."id";
                    '''
                cur.execute(sql)
                conn.commit()

        except Exception as ex:
            print ("Error fent calcul moda")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error fent calcul moda")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculMediana(self):
        try:
            ' Calcul de maxConsum i QualifMaxSup per tal de tenir una qualificaci√≥ energ√®tica amb la que representar amb un color la entitat al mapa '

            if self.dlg.checkNumHabit.isChecked():
                    
                    sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "maxConsum" FLOAT;\n'
                    sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("NumA", "NumB", "NumC", "NumD", "NumE", "NumF", "NumG");\n'
                    sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "QualifMaxSup" VARCHAR;\n'
                    sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =  
                        CASE 
                            WHEN "maxConsum" = "NumA" THEN 'A' 
                            WHEN "maxConsum" = "NumB" THEN 'B' 
                            WHEN "maxConsum" = "NumC" THEN 'C' 
                            WHEN "maxConsum" = "NumD" THEN 'D' 
                            WHEN "maxConsum" = "NumE" THEN 'E' 
                            WHEN "maxConsum" = "NumF" THEN 'F' 
                            ELSE 'G' 
                        END;
                    '''
                    cur.execute(sql)
                    conn.commit()
            
            if self.dlg.checkm2.isChecked():

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "maxConsum";\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" DROP COLUMN IF EXISTS "QualifMaxSup";\n'

                cur.execute(sql)
                conn.commit()

                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "maxConsum" FLOAT;\n'
                sql += f'UPDATE "Capa unida {entitat}_{fitxer}" SET "maxConsum" = GREATEST("m2A", "m2B", "m2C", "m2D", "m2E", "m2F", "m2G");\n'
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN IF NOT EXISTS "QualifMaxSup" VARCHAR;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" SET "QualifMaxSup" =  
                    CASE 
                        WHEN "maxConsum" = "m2A" THEN 'A' 
                        WHEN "maxConsum" = "m2B" THEN 'B' 
                        WHEN "maxConsum" = "m2C" THEN 'C' 
                        WHEN "maxConsum" = "m2D" THEN 'D' 
                        WHEN "maxConsum" = "m2E" THEN 'E' 
                        WHEN "maxConsum" = "m2F" THEN 'F' 
                        ELSE 'G' 
                    END;
                '''
                cur.execute(sql)
                conn.commit()

            ''' El primer que cal fer per a la mediana √©s desfer-se de totes les files que tenen valor 0 a producte_con i producte_emi '''
            sql = f'DELETE FROM "Capa unida {entitat}_{fitxer}" WHERE "producte_con" = 0 OR "producte_con" IS NULL;\n'
            sql += f'DELETE FROM "Capa unida {entitat}_{fitxer}" WHERE "producte_emi" = 0 OR "producte_emi" IS NULL;\n'
            if entitat==llistaEntitats[1]:
                sql += f'DELETE FROM "Capa unida {entitat}_{fitxer}" WHERE "UTM" IS NULL;'
            else:
                sql += f'DELETE FROM "Capa unida {entitat}_{fitxer}" WHERE "id" IS NULL;'
            cur.execute(sql)
            conn.commit()

            ''' Ara cal calcular el index de la mediana '''

            if entitat == llistaEntitats[1]:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_mediana_consum" FLOAT;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" 
                    SET "INDEX_mediana_consum" = 
                        CASE 
                            WHEN CAST("energia prim√†ria no renovable" AS FLOAT) IS NULL OR CAST("energia prim√†ria no renovable" AS FLOAT) = 0 THEN NULL
                            ELSE subquery.median
                        END
                    FROM (
                        SELECT "UTM",
                        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("energia prim√†ria no renovable" AS FLOAT))
                        AS median FROM "Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) 
                    AS subquery
                    WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";\n
                '''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_mediana_emissions" FLOAT;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" 
                    SET "INDEX_mediana_emissions" = 
                        CASE 
                            WHEN CAST("emissions de co2" AS FLOAT) IS NULL OR CAST("emissions de co2" AS FLOAT) = 0 THEN NULL
                            ELSE subquery.median
                        END
                    FROM (
                        SELECT "UTM",
                        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("emissions de co2" AS FLOAT)) 
                        AS median FROM "Capa unida {entitat}_{fitxer}"
                        GROUP BY "UTM"
                    ) 
                    AS subquery
                    WHERE "Capa unida {entitat}_{fitxer}"."UTM" = subquery."UTM";
                '''
            else:
                sql = f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_mediana_consum" FLOAT;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" 
                            SET "INDEX_mediana_consum" = 
                                CASE 
                                    WHEN CAST("energia prim√†ria no renovable" AS FLOAT) IS NULL OR CAST("energia prim√†ria no renovable" AS FLOAT) = 0 THEN NULL
                                    ELSE subquery.median
                                END
                                FROM (
                                    SELECT "id",
                                    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("energia prim√†ria no renovable" AS FLOAT)) 
                                    AS median FROM "Capa unida {entitat}_{fitxer}"
                                    GROUP BY "id"
                                ) 
                            AS subquery
                            WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";\n
                        '''
                sql += f'ALTER TABLE "Capa unida {entitat}_{fitxer}" ADD COLUMN "INDEX_mediana_emissions" FLOAT;\n'
                sql += f'''UPDATE "Capa unida {entitat}_{fitxer}" 
                            SET "INDEX_mediana_emissions" = 
                                CASE 
                                    WHEN CAST("emissions de co2" AS FLOAT) IS NULL OR CAST("emissions de co2" AS FLOAT) = 0 THEN NULL
                                    ELSE subquery.median
                                END
                                FROM (
                                    SELECT "id",
                                    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("emissions de co2" AS FLOAT)) 
                                    AS median FROM "Capa unida {entitat}_{fitxer}"
                                    GROUP BY "id"
                                ) 
                            AS subquery
                            WHERE "Capa unida {entitat}_{fitxer}"."id" = subquery."id";
                        '''
                
            cur.execute(sql)
            conn.commit()
            
        except Exception as ex:
            print ("Error fent mediana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error fent mediana")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
    def dropCapesUnides(self):
        try:
            sql = f'DROP TABLE IF EXISTS "Capa unida {entitat}_{fitxer}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table if exists de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table if exists de capes unides")
            conn.rollback()
            return
    
    def dropCapesReUnidesNumHabit(self):
        try:
            sql = f'''DROP TABLE IF EXISTS "{entitat} amb nombre d'habitatges segons categoria_{fitxer}";'''
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte NumHabit")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table resum recompte NumHabit")
            conn.rollback()
            return
        
    def dropCapesReUnidesm2(self):
        try:
            sql = f'DROP TABLE IF EXISTS "{entitat} amb metres quadrats segons categoria_{fitxer}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte m2")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table resum recompte m2")
            conn.rollback()
            return
        
    def dropCapesReUnidesMitjana(self):
        try:
            sql = f'DROP TABLE IF EXISTS "Mitjana de {entitat}_{fitxer}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte mitjana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table resum recompte mitjana")
            conn.rollback()
            return
        
    def dropCapesReUnidesModa(self):
        try:
            sql = f'DROP TABLE IF EXISTS "Moda de {entitat}_{fitxer}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte moda")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table resum recompte moda")
            conn.rollback()
            return

    def dropCapesReUnidesMediana(self):
        try:
            sql = f'DROP TABLE IF EXISTS "Mediana de {entitat}_{fitxer}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte mediana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a drop table resum recompte mediana")
            conn.rollback()
            return

    def scroll_text(self):
        self.dlg.textEstat.moveCursor(QTextCursor.End)
    
    def updateProgress(self, progress):
        self.dlg.progressBar.setValue(progress)
        QApplication.processEvents()

    def unirCapes(self):
        global uri
        global entitatLayerJoined

        if entitat == llistaEntitats[1]:
            alg_params = {
                "INPUT": entitatLayer,
                "FIELD": "UTM",
                "INPUT_2": habitatgesLayer,
                "FIELD_2": "UTM",
                "FIELDS_TO_COPY": ["referencia cadastral", "metres_cadastre", "qualificaci√≥ de consum energia primaria no renovable", "energia prim√†ria no renovable", "qualificacio emissions de co2", "emissions de co2", "producte_con", "producte_emi"],
                "METHOD": 0,
                "OUTPUT": 'memory:'
            }
        else:
            alg_params = {
                "INPUT": entitatLayer,
                "FIELD": "id",
                "INPUT_2": habitatgesLayer,
                "FIELD_2": f"{entitat}_id",
                "FIELDS_TO_COPY": ["referencia cadastral", "metres_cadastre", "qualificaci√≥ de consum energia primaria no renovable", "energia prim√†ria no renovable", "qualificacio emissions de co2", "emissions de co2", "producte_con", "producte_emi"],
                "METHOD": 0,
                "OUTPUT": 'memory:'
            }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes")
            return

        capa_unida = result["OUTPUT"]
        layerEntitat = capa_unida
        if not layerEntitat.isValid():
            print("ERROR LAYER UNIT")
            return
        layerEntitat.setName(f"Capa unida {entitat}_{fitxer}")
        layerEntitat.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="Capa unida {entitat}_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerEntitat.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerEntitat.crs(), overwrite=True)
            exporter.addFeatures(layerEntitat.getFeatures())
            QApplication.processEvents()

        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return

    def carregarCapesMapa(self):
        global entitatLayerJoined
        try:
            uri.setDataSource(schema1, f"Capa unida {entitat}_{fitxer}", 'geom')
            entitatLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {entitat}_{fitxer}", 'postgres')
        except Exception as ex:
            print ("Error a carregar capes al mapa")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a carregar capes al mapa")
            conn.rollback()
            return
        QApplication.processEvents()

    def reUnirCapesNumHabit(self):
        global entitatLayerResumNumHabit

        layer = entitatLayer
        layerEntitat = entitatLayerJoined

        global uri
        if self.dlg.checkNumHabit.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id",
                "FIELDS_TO_COPY": ['NumA', 'NumB', 'NumC', 'NumD', 'NumE', 'NumF', 'NumG', 'TotalEE'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes NumHabit")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes NumHabit")
            return
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"{entitat.upper()} amb nombre d'habitatges segons categoria")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        entitatLayerResumNumHabit = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{entitat} amb nombre d'habitatges segons categoria_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return

    def reUnirCapesm2(self):
        global entitatLayerResumm2

        layer = entitatLayer
        layerEntitat = entitatLayerJoined

        global uri
        if self.dlg.checkm2.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id",
                "FIELDS_TO_COPY": ['m2A', 'm2B', 'm2C', 'm2D', 'm2E', 'm2F', 'm2G', 'Totalm2'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes m2")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes m2")
            return
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"{entitat.upper()} amb metres quadrats segons categoria")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        entitatLayerResumm2 = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{entitat} amb metres quadrats segons categoria_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return

    def reUnirCapesMitjana(self):
        global entitatLayerResumMitjana

        layer = entitatLayer
        layerEntitat = entitatLayerJoined

        global uri
        if self.dlg.checkMitjana.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id",
                "FIELDS_TO_COPY": ['INDEX_consum', 'INDEX_emissions', 'QualifMaxSup'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes mitjana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes mitjana")
            return
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Mitjana de {entitat.upper()}")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        entitatLayerResumMitjana = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="Mitjana de {entitat}_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return
        
    def reUnirCapesModa(self):
        global entitatLayerResumModa

        layer = entitatLayer
        layerEntitat = entitatLayerJoined

        global uri
        if self.dlg.checkModa.isChecked():
            if self.dlg.checkNumHabit.isChecked() and self.dlg.checkm2.isChecked():
                alg_params = {
                        "INPUT": layer,
                        "FIELD": "id",
                        "INPUT_2": layerEntitat,
                        "FIELD_2": "id",
                        "FIELDS_TO_COPY": ['indexMODAhab', 'indexMODAhabPonderat', 'indexMODAsup', 'indexMODAsupPonderat', 'QualifMaxSup'],
                        "METHOD": 1,
                        "OUTPUT": 'memory:'
                    }
            else:
                if self.dlg.checkm2.isChecked():
                    alg_params = {
                        "INPUT": layer,
                        "FIELD": "id",
                        "INPUT_2": layerEntitat,
                        "FIELD_2": "id",
                        "FIELDS_TO_COPY": ['QualifMaxSup', 'indexMODAsup', 'indexMODAsupPonderat'],
                        "METHOD": 1,
                        "OUTPUT": 'memory:'
                    }
                else:
                    if self.dlg.checkNumHabit.isChecked():
                        alg_params = {
                        "INPUT": layer,
                        "FIELD": "id",
                        "INPUT_2": layerEntitat,
                        "FIELD_2": "id",
                        "FIELDS_TO_COPY": ['indexMODAhab', 'indexMODAhabPonderat', 'QualifMaxSup'],
                        "METHOD": 1,
                        "OUTPUT": 'memory:'
                    }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes moda")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes moda")
            return
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Moda de {entitat.upper()}")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        entitatLayerResumModa = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="Moda de {entitat}_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return

    def reUnirCapesMediana(self):
        global entitatLayerResumMediana

        layer = entitatLayer
        layerEntitat = entitatLayerJoined

        global uri
        if self.dlg.checkMediana.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id",
                "FIELDS_TO_COPY": ['QualifMaxSup', 'INDEX_mediana_consum', 'INDEX_mediana_emissions'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        try:
            result = processing.run("native:joinattributestable", alg_params)
        except Exception as ex:
            print ("Error al proc√©s d'unir capes mediana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error al proc√©s d'unir capes mediana")
            return
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Mediana de {entitat.upper()}")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        entitatLayerResumMediana = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="Mediana de {entitat}_{fitxer}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creaci√≥ de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a creaci√≥ de capes unides")
            conn.rollback()
            return

    def dropFinalCapesIColumnes(self):
        try:
            sql = f'DROP TABLE IF EXISTS "{habitatges}_copy_{fitxer}";\n'
            sql += f'DROP TABLE IF EXISTS "{entitat}_copy_{fitxer}";\n'
            sql += f'DROP TABLE IF EXISTS "Capa unida {entitat}_{fitxer}";\n'
            sql += f'''DROP TABLE IF EXISTS "{entitat} amb nombre d'habitatges segons categoria_{fitxer}";\n'''
            sql += f'DROP TABLE IF EXISTS "{entitat} amb metres quadrats segons categoria_{fitxer}";\n'
            sql += f'DROP TABLE IF EXISTS "Mitjana de {entitat}_{fitxer}";\n'
            sql += f'DROP TABLE IF EXISTS "Moda de {entitat}_{fitxer}";\n'
            sql += f'DROP TABLE IF EXISTS "Mediana de {entitat}_{fitxer}";\n'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error fent drops finals")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error fent drops finals")
            conn.rollback()
            self.dlg.setEnabled(True)
            return 
        
    def barraEstat_noConnectat(self):
        '''Aquesta funci√≥ canvia l'aparen√ßa de la barra d'estat a "No connectat"'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #FFFFFF')
        self.dlg.lblEstatConn.setText('No connectat')
        QApplication.processEvents()
        
    def barraEstat_connectat(self):
        '''Aquesta funci√≥ canvia l'aparen√ßa de la barra d'estat a "Connectat"'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #7fff7f')
        self.dlg.lblEstatConn.setText('Connectat')
        QApplication.processEvents()
        
    def barraEstat_connectant(self):
        '''Aquesta funci√≥ canvia l'aparen√ßa de la barra d'estat a "Connectant..."'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #ffff7f')
        self.dlg.lblEstatConn.setText('Connectant...')
        QApplication.processEvents()

    def maxTotalEE(self):
        global conn
        global cur
        try:
            sql = f'''SELECT MAX("TotalEE") FROM "Capa unida {entitat}_{fitxer}";'''
            cur.execute(sql)
        except Exception as ex:
            print ("Error fent maxTotalEE")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args) 
            print (message)
            QMessageBox.critical(None, "Error", "Error trobant el nombre maxim d'habitatges")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        return cur.fetchone()[0]

    def maxTotalm2(self):
        global conn
        global cur
        try:
            sql = f'''SELECT MAX("Totalm2"::float) FROM "Capa unida {entitat}_{fitxer}";'''
            cur.execute(sql)
            result = cur.fetchone()[0]
        except Exception as ex:
            print ("Error fent maxTotalm2")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args) 
            print (message)
            QMessageBox.critical(None, "Error", "Error trobant el nombre maxim de metres quadrats")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        if (result == None):
            return 0
        else:
            return float(result)

    def on_click_Sortir(self):
        if cur != None and conn != None:
            cur.close()
            conn.close()
        self.estatInicial()
        self.dlg.close()

    def on_click_Inici(self):
        global cur
        global conn
        global textBox
        global nomBD1
        global password1
        global host1
        global user1
        global port1
        global schema1
        global uri

        global habitatges
        global habitatgesLayer
        global entitat
        global entitatLayer
        global entitatLayerJoined
        global entitatLayerResumNumHabit
        global entitatLayerResumm2
        global entitatLayerResumMitjana
        global entitatLayerResumModa
        global entitatLayerResumMediana
        global fitxer

        fitxer = datetime.datetime.now().strftime("%Y%m%d%H%M%S%f")

        uri = QgsDataSourceUri()
        try:
            uri.setConnection(host1, port1, nomBD1, user1, password1)
        except Exception as ex:
            print ("Error a la connexio")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.critical(None, "Error", "Error a la connexio")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

        if entitat == llistaEntitats[0] or entitat == None:
            print("No s'ha seleccionat cap entitat amb la que treballar")
            QMessageBox.warning(None, "Error", "No s'ha seleccionat cap entitat amb la que treballar")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        if (not self.dlg.checkNumHabit.isChecked() and not self.dlg.checkm2.isChecked() and not self.dlg.checkMitjana.isChecked() and not self.dlg.checkModa.isChecked() and not self.dlg.checkMediana.isChecked()):
            print ("No s'ha seleccionat cap c√†lcul que realitzar")
            QMessageBox.warning(None, "Error", "No s'ha seleccionat cap c√†lcul que realitzar")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

        self.updateProgress(10)

        self.dlg.setEnabled(False)
        self.dlg.groupBD.setEnabled(False)
        self.dlg.groupChecks.setEnabled(False)
        self.dlg.groupEntitats.setEnabled(False)
        textBox = f"INICIANT EL PROC√âS...\n"
        self.dlg.textEstat.setText(textBox)
        self.scroll_text()

        ''' Crear copies capes originals '''
        self.crearCopiesCapesEntitats()
        QApplication.processEvents()

        self.updateProgress(20)

        ''' IDs Entitats '''

        textBox += f"Calculant ID d'entitats seleccionades...\n"
        self.dlg.textEstat.setText(textBox)
        self.scroll_text()
        self.calcularCampsHabitatges()
        if not entitat==llistaEntitats[1]:
            self.crearIDentitats()
        QApplication.processEvents()

        self.updateProgress(30)

        ''' Uni√≥ capes '''

        textBox += f"Unint capes seleccionades...\n"
        self.dlg.textEstat.setText(textBox)
        self.scroll_text()
        self.dropCapesUnides()
        self.unirCapes()
        QApplication.processEvents()
        
        self.updateProgress(40)

        ''' Processament c√†lculs '''

        'NumX habitatges per entitats'

        if(self.dlg.checkNumHabit.isChecked()):
            textBox += f"Calculant NumX d'habitatges...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.calculNumX()
            QApplication.processEvents()
        
        'm2 habitatges per entitats'
        
        if(self.dlg.checkm2.isChecked()):
            textBox += f"Calculant m2 d'habitatges...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.calculm2()
            QApplication.processEvents()    
        
        'Mitjana habitatges per entitats'

        if self.dlg.checkMitjana.isChecked():
            textBox += f"Calculant mitjana de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.calculMitjana()
            QApplication.processEvents()

        'Moda habitatges per entitats'

        if self.dlg.checkModa.isChecked():
            textBox += f"Calculant moda de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.calculModa()
            QApplication.processEvents()

        'Mediana habitatges per entitats'

        if self.dlg.checkMediana.isChecked():
            textBox += f"Calculant mediana de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            self.scroll_text()
            self.calculMediana()
            QApplication.processEvents()

        self.updateProgress(50)

        'Carregar capes, fer drops i tornar a unir-les per alleugerir-les'
        'per NumHabit'

        if self.dlg.checkNumHabit.isChecked():
            self.carregarCapesMapa()
            self.dropCapesReUnidesNumHabit()
            self.reUnirCapesNumHabit()
            QApplication.processEvents()      
        
        'per m2'

        if self.dlg.checkm2.isChecked():
            self.carregarCapesMapa()
            self.dropCapesReUnidesm2()
            self.reUnirCapesm2()
            QApplication.processEvents()

        'per mitjana'
        if self.dlg.checkMitjana.isChecked():
            self.carregarCapesMapa()
            self.dropCapesReUnidesMitjana()
            self.reUnirCapesMitjana()
            QApplication.processEvents()

        'per moda'

        if self.dlg.checkModa.isChecked():
            self.carregarCapesMapa()
            self.dropCapesReUnidesModa()
            self.reUnirCapesModa()
            QApplication.processEvents()

        'per mediana'

        if self.dlg.checkMediana.isChecked():
            self.carregarCapesMapa()
            self.dropCapesReUnidesMediana()
            self.reUnirCapesMediana()
            QApplication.processEvents()

        self.updateProgress(60)

        ''' Diagrames de pie chart '''

        NumDiagramColors = {
            'NumA': QColor.fromCmykF(0.85, 0.15, 0.95, 0.30),
            'NumB': QColor.fromCmykF(0.80, 0.00, 1.00, 0.00),
            'NumC': QColor.fromCmykF(0.45, 0.00, 1.00, 0.00),
            'NumD': QColor.fromCmykF(0.10, 0.00, 0.95, 0.00),
            'NumE': QColor.fromCmykF(0.05, 0.30, 1.00, 0.00),
            'NumF': QColor.fromCmykF(0.10, 0.65, 1.00, 0.00),
            'NumG': QColor.fromCmykF(0.05, 0.95, 0.95, 0.00)
        }

        m2DiagramColors = {
            'm2A': QColor.fromCmykF(0.85, 0.15, 0.95, 0.30),
            'm2B': QColor.fromCmykF(0.80, 0.00, 1.00, 0.00),
            'm2C': QColor.fromCmykF(0.45, 0.00, 1.00, 0.00),
            'm2D': QColor.fromCmykF(0.10, 0.00, 0.95, 0.00),
            'm2E': QColor.fromCmykF(0.05, 0.30, 1.00, 0.00),
            'm2F': QColor.fromCmykF(0.10, 0.65, 1.00, 0.00),
            'm2G': QColor.fromCmykF(0.05, 0.95, 0.95, 0.00)
        }

        if self.dlg.checkNumHabit.isChecked():
            uri.setDataSource(schema1, f"{entitat} amb nombre d'habitatges segons categoria_{fitxer}", 'geom')
            capaUnidaNumHabit = QgsVectorLayer(uri.uri(), f"{entitat} amb nombre d'habitatges segons categoria_{fitxer}", 'postgres')
            capaUnidaNumHabit_temp_features = [feat for feat in capaUnidaNumHabit.getFeatures()]
            capaUnidaNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"{entitat.upper()} amb nombre d'habitatges segons categoria", "memory")
            capaUnidaNumHabit_temp_data = capaUnidaNumHabit_temp.dataProvider()
            attributes = capaUnidaNumHabit.dataProvider().fields().toList()
            capaUnidaNumHabit_temp_data.addAttributes(attributes)
            capaUnidaNumHabit_temp.updateFields()
            capaUnidaNumHabit_temp_data.addFeatures(capaUnidaNumHabit_temp_features)
            if capaUnidaNumHabit_temp.isValid():
                QgsProject.instance().addMapLayer(capaUnidaNumHabit_temp)
                QApplication.processEvents()
            else:
                print("No s'ha pogut afegir el layer de numhabit")

            diagramNumHabit = QgsPieDiagram()
            diagramNumHabitSettings = QgsDiagramSettings()
            diagramNumHabitSettings.categoryColors = NumDiagramColors.values()
            diagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
            diagramNumHabitSettings.scaleByArea = False
            diagramNumHabitSettings.scaleBasedVisibility = True
            diagramNumHabitSettings.size = QSizeF(15, 15)
            if entitat == llistaEntitats[1]: # parcel
                diagramNumHabitSettings.minimumScale = 500
                diagramNumHabitSettings.maximumScale = 1
            if entitat == llistaEntitats[2]: # illes
                diagramNumHabitSettings.minimumScale = 4000
                diagramNumHabitSettings.maximumScale = 1
            if entitat == llistaEntitats[3]:
                diagramNumHabitSettings.minimumScale = 10000
                diagramNumHabitSettings.maximumScale = 1
            if entitat == llistaEntitats[4] or entitat == llistaEntitats[5] or entitat == llistaEntitats[6]:
                diagramNumHabitSettings.minimumScale = 40000
                diagramNumHabitSettings.maximumScale = 1
            diagramNumHabitSettings.categoryLabels = ["A", "B", "C", "D", "E", "F", "G"]
            diagramNumHabitSettings.enabled = True

            diagramNumHabitRenderer = QgsSingleCategoryDiagramRenderer()
            diagramNumHabitRenderer.setDiagram(diagramNumHabit)
            diagramNumHabitRenderer.setDiagramSettings(diagramNumHabitSettings)
            
            capaUnidaNumHabit_temp.setDiagramRenderer(diagramNumHabitRenderer)

            propertyx = QgsProperty()
            propertyx.setExpressionString("x(centroid($geometry))")
            propertyx.setActive(True)

            propertyy = QgsProperty()
            propertyy.setExpressionString("y(centroid($geometry))")
            propertyy.setActive(True)

            propertyVisibilitat = QgsProperty()
            propertyVisibilitat.setExpressionString("""CASE WHEN "TotalEE" = 0 THEN False WHEN "TotalEE" IS NULL THEN False ELSE True END """)
            propertyVisibilitat.setActive(True)

            propertyCollection = QgsPropertyCollection("Propietats")
            propertyCollection.setProperty(3, propertyx)
            propertyCollection.setProperty(4, propertyy)
            propertyCollection.setProperty(9, propertyVisibilitat)

            diagramNumHabitLayerSettings = QgsDiagramLayerSettings()
            diagramNumHabitLayerSettings.setDataDefinedProperties(propertyCollection)
                        
            capaUnidaNumHabit_temp.setDiagramLayerSettings(diagramNumHabitLayerSettings)
            
            single_symbol_renderer = capaUnidaNumHabit_temp.renderer().clone()
            symbol = single_symbol_renderer.symbol()
            symbol_layer = QgsSimpleLineSymbolLayer()
            symbol_layer.setWidth(0)
            capaUnidaNumHabit_temp.setRenderer(single_symbol_renderer)

            capaUnidaNumHabit_temp.triggerRepaint()
            QApplication.processEvents()

        if self.dlg.checkm2.isChecked():
            uri.setDataSource(schema1, f"{entitat} amb metres quadrats segons categoria_{fitxer}", 'geom')
            capaUnidam2 = QgsVectorLayer(uri.uri(), f"{entitat} amb metres quadrats segons categoria_{fitxer}", 'postgres')
            capaUnidam2_temp_features = [feat for feat in capaUnidam2.getFeatures()]
            capaUnidam2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"{entitat.upper()} amb metres quadrats segons categoria", "memory")
            capaUnidam2_temp_data = capaUnidam2_temp.dataProvider()
            attributes = capaUnidam2.dataProvider().fields().toList()
            capaUnidam2_temp_data.addAttributes(attributes)
            capaUnidam2_temp.updateFields()
            capaUnidam2_temp_data.addFeatures(capaUnidam2_temp_features)
            if capaUnidam2_temp.isValid():
                QgsProject.instance().addMapLayer(capaUnidam2_temp)
                QApplication.processEvents()
            else:
                print("No s'ha pogut afegir el layer de m2")

            diagramm2 = QgsPieDiagram()
            diagramm2Settings = QgsDiagramSettings()
            diagramm2Settings.categoryColors = m2DiagramColors.values()
            diagramm2Settings.categoryAttributes = m2DiagramColors.keys()
            diagramm2Settings.scaleByArea = False # Deixem en False el escalat per area de manera que no es descontrolin els tamanys amb els zooms
            diagramm2Settings.scaleBasedVisibility = True
            diagramm2Settings.size = QSizeF(15, 15)
            if entitat == llistaEntitats[1]: # parcel
                diagramm2Settings.minimumScale = 500
                diagramm2Settings.maximumScale = 1
            if entitat == llistaEntitats[2]: # illes
                diagramm2Settings.minimumScale = 4000
                diagramm2Settings.maximumScale = 1
            if entitat == llistaEntitats[3]: # seccions
                diagramm2Settings.minimumScale = 10000
                diagramm2Settings.maximumScale = 1
            if entitat == llistaEntitats[4] or entitat == llistaEntitats[5] or entitat == llistaEntitats[6]: # barris districtespostals i districtes
                diagramm2Settings.minimumScale = 40000
                diagramm2Settings.maximumScale = 1
            
            diagramm2Settings.categoryLabels = ["A", "B", "C", "D", "E", "F", "G"]
            diagramm2Settings.enabled = True

            diagramm2Renderer = QgsSingleCategoryDiagramRenderer()
            diagramm2Renderer.setDiagram(diagramm2)
            diagramm2Renderer.setDiagramSettings(diagramm2Settings)

            capaUnidam2_temp.setDiagramRenderer(diagramm2Renderer)

            diagramm2LayerSettings = QgsDiagramLayerSettings()

            ' A partir de la informacio que he tret de la consola de Python podria fer que es quedessin est√†tics els diagrames '

            propertyx = QgsProperty()
            propertyx.setExpressionString("x(centroid($geometry))")
            propertyx.setActive(True)

            propertyy = QgsProperty()
            propertyy.setExpressionString("y(centroid($geometry))")
            propertyy.setActive(True)

            propertyVisibilitat = QgsProperty()
            propertyVisibilitat.setExpressionString("""CASE WHEN "Totalm2" = 0 THEN False WHEN "Totalm2" IS NULL THEN False ELSE True END """)
            propertyVisibilitat.setActive(True)

            propertyCollection = QgsPropertyCollection("Coordenades")
            propertyCollection.setProperty(3, propertyx)
            propertyCollection.setProperty(4, propertyy)
            propertyCollection.setProperty(9, propertyVisibilitat)

            diagramm2LayerSettings.setDataDefinedProperties(propertyCollection)

            capaUnidam2_temp.setDiagramLayerSettings(diagramm2LayerSettings)

            single_symbol_renderer_m2 = capaUnidam2_temp.renderer().clone()
            symbol_m2 = single_symbol_renderer_m2.symbol()
            symbol_layer_m2 = QgsSimpleLineSymbolLayer()
            symbol_layer_m2.setWidth(0)
            capaUnidam2_temp.setRenderer(single_symbol_renderer_m2)

            capaUnidam2_temp.triggerRepaint()
            QApplication.processEvents()
        
        QgsProject.instance().reloadAllLayers()

        self.updateProgress(70)

        ''' Etiquetes de mitjana, mediana i moda '''


        if self.dlg.checkMitjana.isChecked():
            labelMitjana = QgsPalLayerSettings()
            labelMitjana.enabled = True
            labelMitjana.fieldName = """
            CASE
                WHEN "INDEX_consum" IS NOT NULL AND "INDEX_emissions" IS NOT NULL THEN '<div><b><font color="black">' || format_number("INDEX_consum", 1) || '</font></b></div><div><b><font color="#707070">' || format_number("INDEX_emissions", 1) || '</font></b></div>'
                WHEN "INDEX_consum" IS NOT NULL THEN '<div><b><font color="black">' || format_number("INDEX_consum", 1) || '</font></b></div>'
                WHEN "INDEX_emissions" IS NOT NULL THEN '<div><b><font color="#707070">' || format_number("INDEX_emissions", 1) || '</font></b></div>'
                ELSE ''
            END
            """
            labelMitjana.isExpression = True
            labelMitjana.placement = QgsPalLayerSettings.AroundPoint

            text_format = QgsTextFormat()
            text_format.setAllowHtmlFormatting(True)

            background_format = QgsTextBackgroundSettings()
            background_format.setEnabled(True)
            background_format.setType(QgsTextBackgroundSettings.ShapeRectangle)
            background_format.setSizeType(QgsTextBackgroundSettings.SizeBuffer)
            background_format.setSizeUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setSize(QSizeF(3, 3))
            background_format.setRadiiUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setRadii(QSizeF(3, 3))
            background_format.setFillColor(QColor("#ffffff"))
            background_format.setStrokeColor(QColor("#808080"))
            background_format.setStrokeWidthUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setStrokeWidth(1)

            text_format.setBackground(background_format)

            symbology = QgsCategorizedSymbolRenderer()
            symbology.setClassAttribute("QualifMaxSup")

            symbol = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#000000")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol, "Consum (kWh/m¬≤any)"))

            symbol2 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol2.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#707070")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol2, "Emissions (kgCO‚ÇÇ/m¬≤any)"))

            symbol3 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol3.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumA']))
            symbology.addCategory(QgsRendererCategory("A", symbol3, "A"))

            symbol4 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol4.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumB']))
            symbology.addCategory(QgsRendererCategory("B", symbol4, "B"))

            symbol5 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol5.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumC']))
            symbology.addCategory(QgsRendererCategory("C", symbol5, "C"))

            symbol6 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol6.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumD']))
            symbology.addCategory(QgsRendererCategory("D", symbol6, "D"))

            symbol7 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol7.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumE']))
            symbology.addCategory(QgsRendererCategory("E", symbol7, "E"))

            symbol8 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol8.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumF']))
            symbology.addCategory(QgsRendererCategory("F", symbol8, "F"))

            symbol9 = QgsSymbol.defaultSymbol(entitatLayerResumMitjana.geometryType())
            symbol9.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumG']))
            symbology.addCategory(QgsRendererCategory("G", symbol9, "G"))

            labelMitjana.setFormat(text_format)

            entitatLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(labelMitjana))
            entitatLayerResumMitjana.setLabelsEnabled(True)
            entitatLayerResumMitjana.setRenderer(symbology)
            entitatLayerResumMitjana.triggerRepaint()
            QgsProject.instance().addMapLayer(entitatLayerResumMitjana)
            QApplication.processEvents()
        
        if self.dlg.checkModa.isChecked():

            labelModa = QgsPalLayerSettings()
            labelModa.enabled = True

            if self.dlg.checkNumHabit.isChecked():
                labelModa.fieldName = """
                CASE
                    WHEN "indexMODAsup" IS NOT NULL AND "indexMODAsupPonderat" IS NOT NULL THEN '<div><b><font color="black">' || format_number("indexMODAsup", 1) || '</font></b></div><div><b><font color="#707070">' || format_number("indexMODAsupPonderat", 1) || '</font></b></div>'
                    WHEN "indexMODAsup" IS NOT NULL THEN '<div><b><font color="black">' || format_number("indexMODAsup", 1) || '</font></b></div>'
                    WHEN "indexMODAsupPonderat" IS NOT NULL THEN '<div><b><font color="#707070">' || format_number("indexMODAsupPonderat", 1) || '</font></b></div>'
                    ELSE ''
                END
                """

            if self.dlg.checkm2.isChecked():
                labelModa.fieldName = """
                CASE
                    WHEN "indexMODAhab" IS NOT NULL AND "indexMODAhabPonderat" IS NOT NULL THEN '<div><b><font color="black">' || format_number("indexMODAhab", 1) || '</font></b></div><div><b><font color="#707070">' || format_number("indexMODAhabPonderat", 1) || '</font></b></div>'
                    WHEN "indexMODAhab" IS NOT NULL THEN '<div><b><font color="black">' || format_number("indexMODAhab", 1) || '</font></b></div>'
                    WHEN "indexMODAhabPonderat" IS NOT NULL THEN '<div><b><font color="#707070">' || format_number("indexMODAhabPonderat", 1) || '</font></b></div>'
                    ELSE ''
                END
                """
            
            labelModa.isExpression = True
            labelModa.placement = QgsPalLayerSettings.AroundPoint

            ''' * FORMAT DEL TEXT * '''

            text_format = QgsTextFormat()
            text_format.setAllowHtmlFormatting(True)

            ''' * FORMAT DEL FONS DEL TEXT * '''

            background_format = QgsTextBackgroundSettings()
            background_format.setEnabled(True)
            background_format.setType(QgsTextBackgroundSettings.ShapeRectangle)
            background_format.setSizeType(QgsTextBackgroundSettings.SizeBuffer)
            background_format.setSizeUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setSize(QSizeF(3, 3))
            background_format.setRadiiUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setRadii(QSizeF(3, 3))
            background_format.setFillColor(QColor("#ffffff"))
            background_format.setStrokeColor(QColor("#808080"))
            background_format.setStrokeWidthUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setStrokeWidth(1)

            text_format.setBackground(background_format)

            ''' * FORMAT DE LA SIMBOLOGIA DEL LAYER * '''

            symbology = QgsCategorizedSymbolRenderer()
            symbology.setClassAttribute("QualifMaxSup")

            symbol = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#000000")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol, "Consum (kWh/m¬≤any)"))

            symbol2 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol2.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#707070")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol2, "Consum ponderat (kWh/m¬≤any)"))
            
            symbol3 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol3.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumA']))
            symbology.addCategory(QgsRendererCategory("A", symbol3, "A"))

            symbol4 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol4.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumB']))
            symbology.addCategory(QgsRendererCategory("B", symbol4, "B"))

            symbol5 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol5.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumC']))
            symbology.addCategory(QgsRendererCategory("C", symbol5, "C"))

            symbol6 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol6.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumD']))
            symbology.addCategory(QgsRendererCategory("D", symbol6, "D"))

            symbol7 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol7.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumE']))
            symbology.addCategory(QgsRendererCategory("E", symbol7, "E"))

            symbol8 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol8.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumF']))
            symbology.addCategory(QgsRendererCategory("F", symbol8, "F"))

            symbol9 = QgsSymbol.defaultSymbol(entitatLayerResumModa.geometryType())
            symbol9.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumG']))
            symbology.addCategory(QgsRendererCategory("G", symbol9, "G"))

            labelModa.setFormat(text_format)

            entitatLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
            entitatLayerResumModa.setLabelsEnabled(True)
            entitatLayerResumModa.setRenderer(symbology)
            entitatLayerResumModa.triggerRepaint()
            QgsProject.instance().addMapLayer(entitatLayerResumModa)
            QApplication.processEvents()

        if self.dlg.checkMediana.isChecked():
            
            labelMediana = QgsPalLayerSettings()
            labelMediana.enabled = True
            labelMediana.fieldName = """
            CASE
                WHEN "INDEX_mediana_consum" IS NOT NULL AND "INDEX_mediana_emissions" IS NOT NULL THEN '<div><b><font color="black">' || format_number("INDEX_mediana_consum", 1) || '</font></b></div><div><b><font color="#707070">' || format_number("INDEX_mediana_emissions", 1) || '</font></b></div>'
                WHEN "INDEX_mediana_consum" IS NOT NULL THEN '<div><b><font color="black">' || format_number("INDEX_mediana_consum", 1) || '</font></b></div>'
                WHEN "INDEX_mediana_emissions" IS NOT NULL THEN '<div><b><font color="#707070">' || format_number("INDEX_mediana_emissions", 1) || '</font></b></div>'
                ELSE ''
            END
            """
            labelMediana.isExpression = True
            labelMediana.placement = QgsPalLayerSettings.AroundPoint

            text_format = QgsTextFormat()
            text_format.setAllowHtmlFormatting(True)

            background_format = QgsTextBackgroundSettings()
            background_format.setEnabled(True)
            background_format.setType(QgsTextBackgroundSettings.ShapeRectangle)
            background_format.setSizeType(QgsTextBackgroundSettings.SizeBuffer)
            background_format.setSizeUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setSize(QSizeF(3, 3))
            background_format.setRadiiUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setRadii(QSizeF(3, 3))
            background_format.setFillColor(QColor("#ffffff"))
            background_format.setStrokeColor(QColor("#808080"))
            background_format.setStrokeWidthUnit(QgsUnitTypes.RenderMillimeters)
            background_format.setStrokeWidth(1)

            text_format.setBackground(background_format)

            symbology = QgsCategorizedSymbolRenderer()
            symbology.setClassAttribute("QualifMaxSup")

            symbol = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#000000")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol, "Consum (kWh/m¬≤any)"))

            symbol2 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol2.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(QColor("#707070")))
            symbology.addCategory(QgsRendererCategory("xxx", symbol2, "Emissions (kgCO‚ÇÇ/m¬≤any)"))

            symbol3 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol3.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumA']))
            symbology.addCategory(QgsRendererCategory("A", symbol3, "A"))

            symbol4 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol4.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumB']))
            symbology.addCategory(QgsRendererCategory("B", symbol4, "B"))

            symbol5 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol5.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumC']))
            symbology.addCategory(QgsRendererCategory("C", symbol5, "C"))

            symbol6 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol6.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumD']))
            symbology.addCategory(QgsRendererCategory("D", symbol6, "D"))

            symbol7 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol7.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumE']))
            symbology.addCategory(QgsRendererCategory("E", symbol7, "E"))

            symbol8 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol8.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumF']))
            symbology.addCategory(QgsRendererCategory("F", symbol8, "F"))

            symbol9 = QgsSymbol.defaultSymbol(entitatLayerResumMediana.geometryType())
            symbol9.changeSymbolLayer(0, QgsSimpleFillSymbolLayer(NumDiagramColors['NumG']))
            symbology.addCategory(QgsRendererCategory("G", symbol9, "G"))

            labelMediana.setFormat(text_format)

            entitatLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
            entitatLayerResumMediana.setLabelsEnabled(True)
            entitatLayerResumMediana.setRenderer(symbology)
            entitatLayerResumMediana.triggerRepaint()
            QgsProject.instance().addMapLayer(entitatLayerResumMediana)
            QApplication.processEvents()

        QgsProject.instance().reloadAllLayers()
        self.updateProgress(80)
        self.dropFinalCapesIColumnes()
        self.updateProgress(90)
        textBox += f"PROC√âS FINALITZAT!\n"
        self.dlg.textEstat.setText(textBox)
        self.scroll_text()
        self.dlg.setEnabled(True)
        self.dlg.groupBD.setEnabled(True)
        self.dlg.groupChecks.setEnabled(True)
        self.dlg.groupEntitats.setEnabled(True)
        self.updateProgress(100)
        self.estatFinalitzat()
        QMessageBox.information(None, "Proc√©s finalitzat", f"El proc√©s per a l'entitat {entitat} ha finalitzat.", QMessageBox.Ok)
        QApplication.processEvents()

    def populateComboBox(self, combo, list, predef, sort):
        """Procediment per omplir el combo especificat amb la llista subministrada"""
        combo.blockSignals(True)
        combo.clear()
        model = QStandardItemModel(combo)
        predefInList = None
        for elem in list:
            try:
                item = QStandardItem(str(elem))
            except TypeError:
                item = QStandardItem(str(elem))
            model.appendRow(item)
            if elem == predef:
                predefInList = elem
        if sort:
            model.sort(0)
        combo.setModel(model)
        if predef != "":
            if predefInList:
                combo.setCurrentIndex(combo.findText(predefInList))
            else:
                combo.insertItem(0, predef)
                combo.setCurrentIndex(0)
        combo.blockSignals(False)

    def unload(self):
        """Removes the plugin menu item and icon from QGIS GUI."""
        for action in self.actions:
            self.iface.removePluginMenu(
                self.tr(u'&CCU'),
                action)
            #self.iface.removeToolBarIcon(action)
            self.toolbar.removeAction(action)

    def run(self):
        """Run method that performs all the real work"""
        # show the dialog
        self.estatInicial()
        self.dlg.show()
        conn=self.getConnections()
        # Run the dialog event loop
        self.populateComboBox(self.dlg.comboBD, conn, 'Selecciona connexi√≥', True)
        result = self.dlg.exec_()
        # See if OK was pressed
        if result:
            # Do something useful here - delete the line containing pass and
            # substitute with your code.
            pass
