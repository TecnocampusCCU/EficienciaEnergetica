# -*- coding: utf-8 -*-
"""
/***************************************************************************
 EficEnerg
                                 A QGIS plugin
 efic energ
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2023-05-23
        git sha              : $Format:%H$
        copyright            : (C) 2023 by Miquel Rodriguez
        email                : mrodriguezj@edu.tecnocampus.cat
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   Per implementar encara [TODO] :                                       *
 *   - Canviar la moda perquè es calculi també per al nombre d'habitatges, *
 *     no només per als metres quadrats.                                   *
 *   - Canviar plugin per a fer les operaciones per a una sola entitat     *
 *     i no per a les 5 entitats a la vegada.                              *
 *   - Fer la llegenda al mapa pels colors dels diagrames de pastís.       *
 *   - Al finalitzar tot, escriure un manual d'usuari del plugin.          *
 *                                                                         *
 ***************************************************************************/
 
"""


from qgis.PyQt.QtCore import QSettings, QTranslator, QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.PyQt.QtWidgets import QAction, QMessageBox, QApplication

import os
import sys
import processing
from os.path import expanduser
from PyQt5.QtCore import *
from PyQt5.QtGui import *
from PyQt5.QtWidgets import QAction, QMessageBox, QApplication
from PyQt5.QtCore import QSizeF
from PyQt5.QtGui import QColor
from qgis.core import QgsMapLayer
from qgis.core import QgsField
from qgis.core import QgsVectorLayer
from qgis.core import QgsVectorLayerUtils
from qgis.core import QgsVectorLayerExporter
from qgis.core import QgsProject
from qgis.core import QgsGeometry
from qgis.core import QgsFeature
from qgis.core import QgsFeatureRequest
from qgis.core import QgsDataSourceUri
from qgis.core import QgsProcessingException
from qgis.core import QgsCoordinateReferenceSystem
from qgis.core import QgsWkbTypes
from qgis.core import QgsDiagram
from qgis.core import QgsPieDiagram
from qgis.core import QgsDiagramSettings
from qgis.core import QgsDiagramRenderer
from qgis.core import QgsDiagramLayerSettings
from qgis.core import QgsLinearlyInterpolatedDiagramRenderer
from qgis.core import QgsPalLayerSettings
from qgis.core import QgsTextFormat
from qgis.core import QgsVectorLayerSimpleLabeling


import psycopg2
import unicodedata
import datetime
import time
from qgis.utils import iface
from PyQt5.QtSql import *
import qgis.utils
import collections

# Initialize Qt resources from file resources.py
from .resources import *
# Import the code for the dialog
from .eficiencia_energetica_dialog import EficEnergDialog
import os.path

'''Varibles globals'''
Versio_modul = "V_Q3.230720"
nomBD1 = ""
password1 = ""
host1 = ""
port1 = ""
user1 = ""
schema1 = ""
cur = None
conn = None
progress = None
aux = False
textBox = ""
uri = None
numOperacions = 0
numEntitats = 0

habitatges = None
habitatgesLayer = None
parcel = None
parcelLayer = None
parcelLayerJoined = None
parcelLayerResumNumHabit = None
parcelLayerResumm2 = None
parcelLayerResumMitjana = None
parcelLayerResumModa = None
parcelLayerResumMediana = None
illes = None
illesLayer = None
illesLayerJoined = None
illesLayerResumNumHabit = None
illesLayerResumm2 = None
illesLayerResumMitjana = None
illesLayerResumModa = None
illesLayerResumMediana = None
districtes = None
districtesLayer = None
districtesLayerJoined = None
districtesLayerResumNumHabit = None
districtesLayerResumm2 = None
districtesLayerResumMitjana = None
districtesLayerResumModa = None
districtesLayerResumMediana = None
barris = None
barrisLayer = None
barrisLayerJoined = None
barrisLayerResumNumHabit = None
barrisLayerResumm2 = None
barrisLayerResumMitjana = None
barrisLayerResumModa = None
barrisLayerResumMediana = None
seccions = None
seccionsLayer = None
seccionsLayerJoined = None
seccionsLayerResumNumHabit = None
seccionsLayerResumm2 = None
seccionsLayerResumMitjana = None
seccionsLayerResumModa = None
seccionsLayerResumMediana = None

class EficEnerg:
    """QGIS Plugin Implementation."""

    def __init__(self, iface):
        """Constructor.

        :param iface: An interface instance that will be passed to this class
            which provides the hook by which you can manipulate the QGIS
            application at run time.
        :type iface: QgsInterface
        """
        # Save reference to the QGIS interface
        self.iface = iface
        # initialize plugin directory
        self.plugin_dir = os.path.dirname(__file__)
        # initialize locale
        locale = QSettings().value('locale/userLocale')[0:2]
        locale_path = os.path.join(
            self.plugin_dir,
            'i18n',
            'EficEnerg_{}.qm'.format(locale))

        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            QCoreApplication.installTranslator(self.translator)

        # Create the dialog and keep reference

        self.dlg = EficEnergDialog()
        
        self.dlg.pushSortir.clicked.connect(self.on_click_Sortir)
        self.dlg.pushInici.clicked.connect(self.on_click_Inici)
        self.dlg.comboBD.currentIndexChanged.connect(self.on_change_ComboConn)
        self.dlg.comboSchema.currentIndexChanged.connect(self.on_change_comboSchema)
        self.dlg.comboHabitatges.currentIndexChanged.connect(self.on_change_comboHabitatges)
        self.dlg.comboParcel.currentIndexChanged.connect(self.on_change_comboParcel)
        self.dlg.comboIlles.currentIndexChanged.connect(self.on_change_comboIlles)
        self.dlg.comboDistrictes.currentIndexChanged.connect(self.on_change_comboDistrictes)
        self.dlg.comboBarris.currentIndexChanged.connect(self.on_change_comboBarris)
        self.dlg.comboSeccions.currentIndexChanged.connect(self.on_change_comboSeccions)
        self.dlg.checkParcel.stateChanged.connect(self.on_change_checkParcel)
        self.dlg.checkIlles.stateChanged.connect(self.on_change_checkIlles)
        self.dlg.checkDistrictes.stateChanged.connect(self.on_change_checkDistrictes)
        self.dlg.checkBarris.stateChanged.connect(self.on_change_checkBarris)
        self.dlg.checkSeccions.stateChanged.connect(self.on_change_checkSeccions)
        self.dlg.checkNumHabit.stateChanged.connect(self.on_change_checkNumHabit)
        self.dlg.checkm2.stateChanged.connect(self.on_change_checkm2)
        self.dlg.checkMitjana.stateChanged.connect(self.on_change_checkMitjana)
        self.dlg.checkModa.stateChanged.connect(self.on_change_checkModa)
        self.dlg.checkMediana.stateChanged.connect(self.on_change_checkMediana)

        self.dlg.checkParcel.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkIlles.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkDistrictes.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkBarris.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkSeccions.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkNumHabit.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkm2.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkMitjana.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkModa.stateChanged.connect(self.on_change_entitatsIOperacions)
        self.dlg.checkMediana.stateChanged.connect(self.on_change_entitatsIOperacions)

        # Declare instance attributes
        self.actions = []
        self.menu = self.tr(u'&Eficiencia Energetica')

    # noinspection PyMethodMayBeStatic
    def tr(self, message):
        """Get the translation for a string using Qt translation API.

        We implement this ourselves since we do not inherit QObject.

        :param message: String for translation.
        :type message: str, QString

        :returns: Translated version of message.
        :rtype: QString
        """
        # noinspection PyTypeChecker,PyArgumentList,PyCallByClass
        return QCoreApplication.translate('EficEnerg', message)

    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None):
        """Add a toolbar icon to the toolbar.

        :param icon_path: Path to the icon for this action. Can be a resource
            path (e.g. ':/plugins/foo/bar.png') or a normal file system path.
        :type icon_path: str

        :param text: Text that should be shown in menu items for this action.
        :type text: str

        :param callback: Function to be called when the action is triggered.
        :type callback: function

        :param enabled_flag: A flag indicating if the action should be enabled
            by default. Defaults to True.
        :type enabled_flag: bool

        :param add_to_menu: Flag indicating whether the action should also
            be added to the menu. Defaults to True.
        :type add_to_menu: bool

        :param add_to_toolbar: Flag indicating whether the action should also
            be added to the toolbar. Defaults to True.
        :type add_to_toolbar: bool

        :param status_tip: Optional text to show in a popup when mouse pointer
            hovers over the action.
        :type status_tip: str

        :param parent: Parent widget for the new action. Defaults None.
        :type parent: QWidget

        :param whats_this: Optional text to show in the status bar when the
            mouse pointer hovers over the action.

        :returns: The action that was created. Note that the action is also
            added to self.actions list.
        :rtype: QAction
        """

        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip is not None:
            action.setStatusTip(status_tip)

        if whats_this is not None:
            action.setWhatsThis(whats_this)

        if add_to_toolbar:
            # Adds plugin icon to Plugins toolbar
            self.iface.addToolBarIcon(action)

        if add_to_menu:
            self.iface.addPluginToMenu(
                self.menu,
                action)

        self.actions.append(action)

        return action

    def initGui(self):
        """Create the menu entries and toolbar icons inside the QGIS GUI."""

        icon_path = ':/plugins/eficiencia_energetica/icon.png'
        self.add_action(
            icon_path,
            text=self.tr(u''),
            callback=self.run,
            parent=self.iface.mainWindow())

        # will be set False in run()
        self.first_start = True

    def on_change_ComboConn(self):
        global aux
        global nomBD1
        global password1
        global host1
        global port1
        global user1
        global schema1
        global cur
        global conn
        global textBox
        global uri
        s = QSettings()
        self.dlg.comboBarris.clear()
        self.dlg.comboDistrictes.clear()
        self.dlg.comboHabitatges.clear()
        self.dlg.comboIlles.clear()
        self.dlg.comboParcel.clear()
        self.dlg.comboSeccions.clear()
        select = 'Selecciona connexió'
        nom_conn = self.dlg.comboBD.currentText()

        if nom_conn != select:
            aux = True
            s.beginGroup("PostgreSQL/connections/"+nom_conn)
            currentKeys = s.childKeys()

            nomBD1 = s.value("database", "")
            password1 = s.value("password", "")
            host1 = s.value("host", "")
            port1 = s.value("port", "")
            user1 = s.value("username", "")
            schema1 = s.value("schema", "")

            self.barraEstat_connectant()
            textBox += f"\nConnectant a la base de dades {nomBD1}...\n"
            self.dlg.textEstat.setText(textBox)
            self.dlg.lblEstatConn.setAutoFillBackground(True)
            QApplication.processEvents()

            # Connexio
            nomBD = nomBD1.encode('ascii', 'ignore')
            user = user1.encode('ascii', 'ignore')
            server = host1.encode('ascii', 'ignore')
            password = password1.encode('ascii', 'ignore')
            #schema = schema1.encode('ascii', 'ignore')
            try:
                estructura = "dbname='"+ nomBD.decode("utf-8") + "' user='" + user.decode("utf-8") +"' host='" + server.decode("utf-8") +"' password='" + password.decode("utf-8") + "'" # + "'schema='" + schema.decode("utf-8") + "'"
                conn = psycopg2.connect(estructura)
                self.barraEstat_connectat()
                textBox += f"\nConnectat a la base de dades {nomBD1}\n"
                textBox += "\nSelecciona les entitats amb les que vulguis treballar i indica amb quines entitats treballaràs així com els camps que vols calcular i inicia el procés"
                self.dlg.textEstat.setText(textBox)
                cur = conn.cursor()
                schemas = self.getSchemas()
                self.populateComboBox(self.dlg.comboSchema, schemas, "Selecciona un esquema", True)
                self.dlg.comboSchema.setEnabled(True)
                uri = QgsDataSourceUri()
                uri.setConnection(host1, port1, nomBD1, user1, password1)
                self.dlg.labelSchema.setVisible(True)
                self.dlg.comboSchema.setVisible(True)

            except Exception as ex:
                self.estatInicial()
                print ("I am unable to connect to the database")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.information(None, "Error", "Error canvi connexió")
                if conn is not None:
                    conn.rollback()
                self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #ff7f7f')
                self.dlg.lblEstatConn.setText('Error: Hi ha algun camp erroni.')
                return
            
        else:
            aux = False
            self.barraEstat_noConnectat()

    def on_change_comboSchema(self):
        global schema1
        schema1 = self.dlg.comboSchema.currentText()

        self.dlg.groupEntitats.setEnabled(True)
        self.dlg.comboHabitatges.setEnabled(True)
        self.dlg.comboParcel.setEnabled(True)
        self.dlg.comboIlles.setEnabled(True)
        self.dlg.comboDistrictes.setEnabled(True)
        self.dlg.comboBarris.setEnabled(True)
        self.dlg.comboSeccions.setEnabled(True)
        self.dlg.groupChecks.setEnabled(True)
        self.dlg.pushInici.setEnabled(True)

        self.dlg.groupEntitats.setVisible(True)
        self.dlg.labelHabitatges.setVisible(True)
        self.dlg.comboHabitatges.setVisible(True)
        self.dlg.groupChecks.setVisible(True)

        layers = self.getLayers(schema1)
        self.populateComboBox(self.dlg.comboHabitatges, layers, "Selecciona els habitatges", True)
        self.populateComboBox(self.dlg.comboParcel, layers, "Selecciona la parcel·la", True)
        self.populateComboBox(self.dlg.comboIlles, layers, "Selecciona les illes", True)
        self.populateComboBox(self.dlg.comboDistrictes, layers, "Selecciona els districtes", True)
        self.populateComboBox(self.dlg.comboBarris, layers, "Selecciona els barris", True)
        self.populateComboBox(self.dlg.comboSeccions, layers, "Selecciona les seccions", True)
    
    def on_change_comboBarris(self):
        global uri
        global barris
        global barrisLayer
        barris = self.dlg.comboBarris.currentText()
        uri.setDataSource(schema1, barris, 'geom')
        barrisLayer = QgsVectorLayer(uri.uri(), barris, 'postgres')
    
    def on_change_comboDistrictes(self):
        global uri
        global districtes
        global districtesLayer
        districtes = self.dlg.comboDistrictes.currentText()
        uri.setDataSource(schema1, districtes, 'geom')
        districtesLayer = QgsVectorLayer(uri.uri(), districtes, 'postgres')
    
    def on_change_comboHabitatges(self):
        global habitatges
        global habitatgesLayer
        global uri
        habitatges = self.dlg.comboHabitatges.currentText()
        uri.setDataSource(schema1, habitatges, 'geom')
        habitatgesLayer = QgsVectorLayer(uri.uri(), habitatges, 'postgres')
    
    def on_change_comboParcel(self):
        global uri
        global parcel
        global parcelLayer
        parcel = self.dlg.comboParcel.currentText()
        uri.setDataSource(schema1, parcel, 'geom')
        parcelLayer = QgsVectorLayer(uri.uri(), parcel, 'postgres')
        
    def on_change_comboSeccions(self):
        global uri
        global seccions
        global seccionsLayer
        seccions = self.dlg.comboSeccions.currentText()
        uri.setDataSource(schema1, seccions, 'geom')
        seccionsLayer = QgsVectorLayer(uri.uri(), seccions, 'postgres')
        
    def on_change_comboIlles(self):
        global uri
        global illes
        global illesLayer
        illes = self.dlg.comboIlles.currentText()
        uri.setDataSource(schema1, illes, 'geom')
        illesLayer = QgsVectorLayer(uri.uri(), illes, 'postgres')

    def on_change_checkParcel(self):
        global numEntitats
        if self.dlg.checkParcel.isChecked():
            self.dlg.labelParcel.setVisible(True)
            self.dlg.comboParcel.setVisible(True)
            numEntitats += 1
        else:
            self.dlg.labelParcel.setVisible(False)
            self.dlg.comboParcel.setVisible(False)
            numEntitats -= 1
    
    def on_change_checkIlles(self):
        global numEntitats
        if self.dlg.checkIlles.isChecked():
            self.dlg.labelIlles.setVisible(True)
            self.dlg.comboIlles.setVisible(True)
            numEntitats += 1
        else:
            self.dlg.labelIlles.setVisible(False)
            self.dlg.comboIlles.setVisible(False)
            numEntitats -= 1

    def on_change_checkDistrictes(self):
        global numEntitats
        if self.dlg.checkDistrictes.isChecked():
            self.dlg.labelDistrictes.setVisible(True)
            self.dlg.comboDistrictes.setVisible(True)
            numEntitats += 1
        else:
            self.dlg.labelDistrictes.setVisible(False)
            self.dlg.comboDistrictes.setVisible(False)
            numEntitats -= 1
    
    def on_change_checkBarris(self):
        global numEntitats
        if self.dlg.checkBarris.isChecked():
            self.dlg.labelBarris.setVisible(True)
            self.dlg.comboBarris.setVisible(True)
            numEntitats += 1
        else:
            self.dlg.labelBarris.setVisible(False)
            self.dlg.comboBarris.setVisible(False)
            numEntitats -= 1
    
    def on_change_checkSeccions(self):
        global numEntitats
        if self.dlg.checkSeccions.isChecked():
            self.dlg.labelSeccions.setVisible(True)
            self.dlg.comboSeccions.setVisible(True)
            numEntitats += 1
        else:
            self.dlg.labelSeccions.setVisible(False)
            self.dlg.comboSeccions.setVisible(False)
            numEntitats -= 1

    def on_change_entitatsIOperacions(self):
        if numEntitats > 1 or numOperacions > 2:
            self.dlg.labelAvis.setVisible(True)
        else:
            self.dlg.labelAvis.setVisible(False)

    def on_change_checkNumHabit(self):
        global numOperacions
        if self.dlg.checkNumHabit.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def on_change_checkm2(self):
        global numOperacions
        if self.dlg.checkm2.isChecked():
            self.dlg.checkModa.setEnabled(True)
            numOperacions += 1
        else:
            self.dlg.checkModa.setEnabled(False)
            self.dlg.checkModa.setChecked(False)
            numOperacions -= 1
    
    def on_change_checkMitjana(self):
        global numOperacions
        if self.dlg.checkMitjana.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def on_change_checkModa(self):
        global numOperacions
        if self.dlg.checkModa.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def on_change_checkMediana(self):
        global numOperacions
        if self.dlg.checkMediana.isChecked():
            numOperacions += 1
        else:
            numOperacions -= 1

    def ompleCombos(self, combo, llista, predef, sort):
        combo.blockSignals(True)
        combo.clear()
        model=QStandardItemModel(combo)
        predefInList=None
        for elem in llista:
            try:
                if isinstance(elem, tuple):
                    item = QStandardItem(unicode(elem[0]))
                else:
                    item = QStandardItem(str(elem))
            except TypeError:
                item = QStandardItem(str(elem[0]))
            model.appendRow(item)
            if elem == predef:
                predefInList = elem
        combo.setModel(model)
        if predef != "":
            if predefInList:
                combo.setCurrentIndex(combo.findText(predefInList))
            else:
                combo.insertItem(0, predef)
                combo.setCurrentIndex(0)
        combo.blockSignals(False)

    def getConnections(self):
        '''Aquesta funció retorna les connexions que estan guardades en el projecte.'''
        s = QSettings()
        s.beginGroup("PostgreSQL/connections")
        currentConnections = s.childGroups()
        s.endGroup()
        return currentConnections
    
    def getLayers(self, schema):
        global nomBD1
        global password1
        global host1
        global port1
        global user1
        global cur
        global conn

        sql = f"SELECT table_name FROM information_schema.tables WHERE table_schema = '{schema}' AND (table_type = 'BASE TABLE' OR table_type = 'VIEW')"
        try:
            cur.execute(sql)
            layers = [layer[0] for layer in cur.fetchall()]
        except Exception as ex:
            print("Unable to connect to database")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print(message)
            print(nomBD1)
            QMessageBox.information(None, "Error", "Error canvi connexió")
            conn.rollback()
            self.dlg.comboDB.setCurrentIndex(0)
            self.dlg.setEnabled(True)
            return
        return layers
    
    def getSchemas(self):
        global nomBD1
        global password1
        global host1
        global port1
        global user1
        global cur
        global conn

        sql = f"SELECT schema_name FROM information_schema.schemata"
        try:
            cur.execute(sql)
            schemas = [schema[0] for schema in cur.fetchall()]
        except Exception as ex:
            print("Unable to connect to database")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print(message)
            print(nomBD1)
            QMessageBox.information(None, "Error", "Error canvi connexió")
            conn.rollback()
            self.dlg.comboDB.setCurrentIndex(0)
            self.dlg.setEnabled(True)
            return
        return schemas

    def estatInicial(self):
        global aux
        global textBox
        global Versio_modul
        aux = False
        self.dlg.comboBD.setCurrentIndex(0)
        self.barraEstat_noConnectat()
        self.dlg.comboBD.setEnabled(True)
        self.dlg.comboSchema.setEnabled(False)
        self.dlg.comboBarris.setEnabled(False)
        self.dlg.comboDistrictes.setEnabled(False)
        self.dlg.comboHabitatges.setEnabled(False)
        self.dlg.comboIlles.setEnabled(False)
        self.dlg.comboParcel.setEnabled(False)
        self.dlg.comboSeccions.setEnabled(False)
        self.dlg.checkNumHabit.setChecked(False)
        self.dlg.checkm2.setChecked(False)
        self.dlg.checkMitjana.setChecked(False)
        self.dlg.checkModa.setChecked(False)
        self.dlg.checkMediana.setChecked(False)
        self.dlg.checkBarris.setChecked(False)
        self.dlg.checkDistrictes.setChecked(False)
        self.dlg.checkIlles.setChecked(False)
        self.dlg.checkParcel.setChecked(False)
        self.dlg.checkSeccions.setChecked(False)
        self.dlg.comboBarris.clear()
        self.dlg.comboDistrictes.clear()
        self.dlg.comboHabitatges.clear()
        self.dlg.comboIlles.clear()
        self.dlg.comboParcel.clear()
        self.dlg.comboSeccions.clear()
        self.dlg.textEstat.clear()
        self.dlg.versio.setText(Versio_modul)
        self.dlg.groupEntitats.setEnabled(False)
        self.dlg.groupChecks.setEnabled(False)
        self.dlg.pushInici.setEnabled(False)
        self.dlg.groupChecks.setVisible(False)
        self.dlg.groupEntitats.setVisible(False)
        self.dlg.labelHabitatges.setVisible(False)
        self.dlg.comboHabitatges.setVisible(False)
        self.dlg.labelParcel.setVisible(False)
        self.dlg.comboParcel.setVisible(False)
        self.dlg.labelIlles.setVisible(False)
        self.dlg.comboIlles.setVisible(False)
        self.dlg.labelDistrictes.setVisible(False)
        self.dlg.comboDistrictes.setVisible(False)
        self.dlg.labelBarris.setVisible(False)
        self.dlg.comboBarris.setVisible(False)
        self.dlg.labelSeccions.setVisible(False)
        self.dlg.comboSeccions.setVisible(False)
        self.dlg.labelSchema.setVisible(False)
        self.dlg.comboSchema.setVisible(False)
        self.dlg.checkModa.setEnabled(False)
        self.dlg.labelAvis.setVisible(False)
        textBox = "Selecciona una base de dades...\n"
        self.dlg.textEstat.setText(textBox)
        self.dlg.setEnabled(True)
    
    def estatFinalitzat(self):
        self.dlg.comboBD.setEnabled(False)
        self.dlg.comboSchema.setEnabled(False)
        self.dlg.comboHabitatges.setEnabled(False)
        self.dlg.comboParcel.setEnabled(False)
        self.dlg.comboIlles.setEnabled(False)
        self.dlg.comboDistrictes.setEnabled(False)
        self.dlg.comboBarris.setEnabled(False)
        self.dlg.comboSeccions.setEnabled(False)
        self.dlg.groupChecks.setEnabled(False)
        self.dlg.pushInici.setEnabled(False)
        self.dlg.pushSortir.setEnabled(True)
        self.dlg.labelAvis.setVisible(False)

    def crearCopiesCapesEntitats(self, entitat):
        global habitatgesLayer
        global parcelLayer
        global illesLayer
        global districtesLayer
        global barrisLayer
        global seccionsLayer
        
        try:
            copy_table_name = f"{entitat}_copy"
            drop_table_query = f'DROP TABLE IF EXISTS "{schema1}"."{copy_table_name}"'
            cur.execute(drop_table_query)
            create_table_query = f'CREATE TABLE "{schema1}"."{copy_table_name}" (LIKE "{schema1}"."{entitat}" INCLUDING CONSTRAINTS)'
            cur.execute(create_table_query)
            insert_features_query = f'INSERT INTO "{schema1}"."{copy_table_name}" SELECT * FROM "{schema1}"."{entitat}"'
            cur.execute(insert_features_query)
            conn.commit()

        except Exception as ex:
            print ("Error a creació de capes copia")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes copia")
            conn.rollback()
            return

        uri.setDataSource(schema1, f"{copy_table_name}", 'geom')
        if (entitat == habitatges):
            habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        if (entitat == parcel):
            parcelLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        if (entitat == illes):
            illesLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        if (entitat == districtes):
            districtesLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        if (entitat == barris):
            barrisLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        if (entitat == seccions):
            seccionsLayer = QgsVectorLayer(uri.uri(), f'"{copy_table_name}"', 'postgres')
        else:
            return

    def crearIDentitats(self):
        global habitatgesLayer
        '''Funcio per calcular els ID de les entitats que es combinaran amb els habitatges'''
        sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "{illes}_id";\n'
        sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "{seccions}_id";\n'
        sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "{districtes}_id";\n'
        sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "{barris}_id";'
        cur.execute(sql)
        conn.commit()

        try:
            if self.dlg.checkIlles.isChecked():
                sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "{illes}_id" INTEGER;\n'
                sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "{illes}_id" = "{schema1}"."{illes}_copy".id_0 FROM "{schema1}"."{illes}_copy" WHERE ST_Intersects("{schema1}"."{habitatges}_copy".geom, "{schema1}"."{illes}_copy".geom);'
                cur.execute(sql)
                conn.commit()
            if self.dlg.checkSeccions.isChecked():
                sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "{seccions}_id" INTEGER;\n'
                sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "{seccions}_id" = "{schema1}"."{seccions}_copy".id_0 FROM "{schema1}"."{seccions}_copy" WHERE ST_Intersects("{schema1}"."{habitatges}_copy".geom, "{schema1}"."{seccions}_copy".geom);'
                cur.execute(sql)
                conn.commit()
            if self.dlg.checkDistrictes.isChecked():
                sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "{districtes}_id" INTEGER;\n'
                sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "{districtes}_id" = "{schema1}"."{districtes}_copy".id_0 FROM "{schema1}"."{districtes}_copy" WHERE ST_Intersects("{schema1}"."{habitatges}_copy".geom, "{schema1}"."{districtes}_copy".geom);'
                cur.execute(sql)
                conn.commit()
            if self.dlg.checkBarris.isChecked():
                sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "{barris}_id" INTEGER;\n'
                sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "{barris}_id" = "{schema1}"."{barris}_copy".id_0 FROM "{schema1}"."{barris}_copy" WHERE ST_Intersects("{schema1}"."{habitatges}_copy".geom, "{schema1}"."{barris}_copy".geom);'
                cur.execute(sql)
                conn.commit()  

            uri.setDataSource(schema1, f"{habitatges}_copy", 'geom')
            habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{habitatges}_copy"', 'postgres')
        except Exception as ex:
            print ("Error calculant ID auxiliars entitats")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error calculant ID auxiliars entitats")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calcularCampsHabitatges(self):
        global habitatges
        global habitatgesLayer
        
        sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "UTM";\n'
        sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "producte_con";\n'
        sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" DROP COLUMN IF EXISTS "producte_emi";'
        cur.execute(sql)
        conn.commit()

        try:
            sql = f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "UTM" VARCHAR;\n'
            sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "UTM" = LEFT("referencia cadastral", 7);\n'

            sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "producte_con" FLOAT;\n'
            sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "producte_con" = CAST("energia primària no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT);\n'
            
            sql += f'ALTER TABLE "{schema1}"."{habitatges}_copy" ADD COLUMN "producte_emi" FLOAT;\n'
            sql += f'UPDATE "{schema1}"."{habitatges}_copy" SET "producte_emi" = CAST("emissions de co2" AS FLOAT) * CAST("metres_cadastre" AS FLOAT);'

            cur.execute(sql)
            conn.commit()    

            uri.setDataSource(schema1, f"{habitatges}_copy", 'geom')
            habitatgesLayer = QgsVectorLayer(uri.uri(), f'"{habitatges}_copy"', 'postgres')    
        except Exception as ex:
            print ("Error calculant camps auxiliars habitatges")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error calculant camps auxiliars habitatges")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculNumX(self, entitat):

        ''' Drop de les columnes en cas d'existir '''
        try:
            drop = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumA";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumB";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumC";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumD";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumE";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumF";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "NumG";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "TotalEE";'
            cur.execute(drop)
            conn.commit()
        except Exception as ex:
            print ("Error dropping NumX columns")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error dropping NumX columns")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
        '''Calcul de les diferents columnes NumA, NumB, ..., NumG i TotalEE'''
        if entitat == parcel:
            try:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumA" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumA" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'A' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumB" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumB" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'B' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumC" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumC" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'C' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumD" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumD" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'D' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumE" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumE" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'E' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumF" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumF" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'F' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumG" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumG" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'G' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "TotalEE" integer;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "TotalEE" = "NumA" + "NumB" + "NumC" + "NumD" + "NumE" + "NumF" + "NumG";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating NumX columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.information(None, "Error", "Error calculating NumX columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
        else:
            try:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumA" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumA" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'A' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumB" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumB" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'B' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumC" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumC" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'C' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumD" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumD" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'D' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumE" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumE" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'E' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumF" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumF" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'F' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "NumG" integer;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "NumG" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'G' THEN 1 ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "TotalEE" integer;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "TotalEE" = "NumA" + "NumB" + "NumC" + "NumD" + "NumE" + "NumF" + "NumG";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating NumX columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.information(None, "Error", "Error calculating NumX columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
        
    def calculm2(self, entitat):
        '''Drop de les columnes en cas d'existir'''
        try:
            drop = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2A";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2B";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2C";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2D";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2E";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2F";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "m2G";\n'
            drop += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" DROP COLUMN IF EXISTS "Totalm2";'
            cur.execute(drop)
            conn.commit()
        except Exception as ex:
            print ("Error dropping m2X columns")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error dropping m2X columns")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
        '''Calcul m2A, m2B, ..., m2G, Totalm2'''
        if entitat == parcel:
            try:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2A" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2A" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'A' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2B" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2B" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'B' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2C" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2C" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'C' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2D" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2D" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'D' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2E" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2E" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'E' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2F" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2F" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'F' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2G" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2G" = subquery.sum_count FROM (SELECT "UTM", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'G' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "Totalm2" float;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "Totalm2" = "m2A" + "m2B" + "m2C" + "m2D" + "m2E" + "m2F" + "m2G";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating m2X columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.information(None, "Error", "Error calculating m2X columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return
        else:
            try:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2A" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2A" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'A' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2B" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2B" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'B' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2C" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2C" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'C' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2D" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2D" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'D' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2E" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2E" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'E' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2F" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2F" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'F' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "m2G" float;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "m2G" = subquery.sum_count FROM (SELECT "id_0", SUM(CASE WHEN "qualificació de consum energia primaria no renovable" = 'G' THEN CAST(metres_cadastre AS float) ELSE 0 END) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "Totalm2" float;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "Totalm2" = "m2A" + "m2B" + "m2C" + "m2D" + "m2E" + "m2F" + "m2G";'
                cur.execute(sql)
                conn.commit()
            except Exception as ex:
                print ("Error calculating m2X columns")
                template = "An exception of type {0} occurred. Arguments:\n{1!r}"
                message = template.format(type(ex).__name__, ex.args)
                print (message)
                QMessageBox.information(None, "Error", "Error calculating m2X columns")
                conn.rollback()
                self.dlg.setEnabled(True)
                return

    def calculMitjana(self, entitat):
        try:
            ''' Sumatoris '''
            if entitat == parcel:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_product_consums" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_product_consums" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("producte_con" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_product_emissions" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_product_emissions" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("producte_emi" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n'
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_m2" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_m2" = subquery.sum_count FROM (SELECT "UTM", SUM(CAST("metres_cadastre" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "UTM") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";'
                cur.execute(sql)
                conn.commit()
            else:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_product_consums" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_product_consums" = subquery.sum_count FROM (SELECT "id_0", SUM(CAST("producte_con" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_product_emissions" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_product_emissions" = subquery.sum_count FROM (SELECT "id_0", SUM(CAST("producte_emi" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n'
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "sum_m2" FLOAT;\n'
                sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "sum_m2" = subquery.sum_count FROM (SELECT "id_0", SUM(CAST("metres_cadastre" AS FLOAT)) AS sum_count FROM "{schema1}"."Capa unida {entitat}" GROUP BY "id_0") AS subquery WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";'
                cur.execute(sql)
                conn.commit()
            ''' Crear indexs (que son camps nous a la taula unida) '''
            sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_consum" FLOAT;\n'
            sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "INDEX_consum" = CASE WHEN "sum_m2" = 0 THEN 0 ELSE ("sum_product_consums"/"sum_m2") END;\n'
            sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_emissions" FLOAT;\n'
            sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "INDEX_emissions" = CASE WHEN "sum_m2" = 0 THEN 0 ELSE ("sum_product_emissions"/"sum_m2") END;'
            cur.execute(sql)
            conn.commit()

        except Exception as ex:
            print ("Error fent sumes de camps de la mitjana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error fent sumes de camps de la mitjana")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculModa(self, entitat):
        try:
            sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "maxConsum" FLOAT;\n'
            sql += f'UPDATE "{schema1}"."Capa unida {entitat}" SET "maxConsum" = GREATEST("m2A", "m2B", "m2C", "m2D", "m2E", "m2F", "m2G");\n'
            sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "QualifMaxSup" VARCHAR;\n'
            sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" SET "QualifMaxSup" =  
	            CASE 
		            WHEN "maxConsum" = "m2A" THEN 'A' 
		            WHEN "maxConsum" = "m2B" THEN 'B' 
		            WHEN "maxConsum" = "m2C" THEN 'C' 
		            WHEN "maxConsum" = "m2D" THEN 'D' 
		            WHEN "maxConsum" = "m2E" THEN 'E' 
		            WHEN "maxConsum" = "m2F" THEN 'F' 
		            ELSE 'G' 
	            END;
            '''
            cur.execute(sql)
            conn.commit()

            if entitat==parcel:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "indexMODAsup" FLOAT;\n'
                sql += f'''
                UPDATE "{schema1}"."Capa unida {entitat}" AS c
                SET "indexMODAsup" = subquery.moda
                FROM (
                    SELECT "UTM",
                        (
                            SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("energia primària no renovable" AS FLOAT)
                                    ELSE 0
                                END
                            ) / NULLIF(SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN 1
                                    ELSE 0
                                END), 0
                            )
                        ) AS moda
                    FROM {schema1}."Capa unida {entitat}"
                    GROUP BY "UTM"
                ) AS subquery
                WHERE c."UTM" = subquery."UTM"\n;
                '''

                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "indexMODAsupPonderat" FLOAT;\n'

                sql += f'''
                UPDATE "{schema1}"."Capa unida {entitat}" AS c
                SET "indexMODAsupPonderat" = subquery.moda
                FROM (
                    SELECT "UTM",
                        (
                            SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("energia primària no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                    ELSE 0
                                END
                            ) / NULLIF(SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("metres_cadastre" AS FLOAT)
                                    ELSE 0
                                END), 0
                            )
                        ) AS moda   
                    FROM {schema1}."Capa unida {entitat}"
                    GROUP BY "UTM"
                ) AS subquery
                WHERE c."UTM" = subquery."UTM";   
                '''
                cur.execute(sql)
                conn.commit()

                
            else:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "indexMODAsup" FLOAT;\n'
                sql += f'''
                UPDATE "{schema1}"."Capa unida {entitat}" AS c
                SET "indexMODAsup" = subquery.moda
                FROM (
                    SELECT "id_0",
                        (
                            SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("energia primària no renovable" AS FLOAT)
                                    ELSE 0
                                END
                            ) / NULLIF(SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN 1
                                    ELSE 0
                                END), 0
                            )
                        ) AS moda
                    FROM {schema1}."Capa unida {entitat}"
                    GROUP BY "id_0"
                ) AS subquery
                WHERE c."id_0" = subquery."id_0"\n;
                '''

                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "indexMODAsupPonderat" FLOAT;\n'
                sql += f'''
                UPDATE "{schema1}"."Capa unida {entitat}" AS c
                SET "indexMODAsupPonderat" = subquery.moda
                FROM (
                    SELECT "id_0",
                        (
                            SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("energia primària no renovable" AS FLOAT) * CAST("metres_cadastre" AS FLOAT)
                                    ELSE 0
                                END
                            ) / NULLIF(SUM (
                                CASE
                                    WHEN "qualificació de consum energia primaria no renovable" = "QualifMaxSup"
                                        THEN CAST("metres_cadastre" AS FLOAT)
                                    ELSE 0
                                END), 0
                            )
                        ) AS moda
                    FROM {schema1}."Capa unida {entitat}"
                    GROUP BY "id_0"
                ) AS subquery
                WHERE c."id_0" = subquery."id_0";
                '''
                cur.execute(sql)
                conn.commit()
        except Exception as ex:
            print ("Error fent calcul moda")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error fent calcul moda")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

    def calculMediana(self, entitat):
        try:
            ''' El primer que cal fer per a la mediana és desfer-se de totes les files que tenen valor 0 a producte_con i producte_emi '''
            sql = f'DELETE FROM "{schema1}"."Capa unida {entitat}" WHERE "producte_con" = 0 OR "producte_con" IS NULL;\n'
            sql += f'DELETE FROM "{schema1}"."Capa unida {entitat}" WHERE "producte_emi" = 0 OR "producte_emi" IS NULL;\n'
            if entitat == parcel:
                sql += f'DELETE FROM "{schema1}"."Capa unida {entitat}" WHERE "UTM" IS NULL;'
            else:
                sql += f'DELETE FROM "{schema1}"."Capa unida {entitat}" WHERE "id_0" IS NULL;'
            cur.execute(sql)
            conn.commit()

            ''' Ara cal calcular el index de la mediana '''

            if entitat == parcel:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_mediana_consum" FLOAT;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" 
                    SET "INDEX_mediana_consum" = 
                        CASE 
                            WHEN CAST("energia primària no renovable" AS FLOAT) IS NULL OR CAST("energia primària no renovable" AS FLOAT) = 0 THEN NULL
                            ELSE subquery.median
                        END
                    FROM (
                        SELECT "UTM",
                        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("energia primària no renovable" AS FLOAT))
                        AS median FROM "{schema1}"."Capa unida {entitat}"
                        GROUP BY "UTM"
                    ) 
                    AS subquery
                    WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";\n
                '''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_mediana_emissions" FLOAT;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" 
                    SET "INDEX_mediana_emissions" = 
                        CASE 
                            WHEN CAST("emissions de co2" AS FLOAT) IS NULL OR CAST("emissions de co2" AS FLOAT) = 0 THEN NULL
                            ELSE subquery.median
                        END
                    FROM (
                        SELECT "UTM",
                        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("emissions de co2" AS FLOAT)) 
                        AS median FROM "{schema1}"."Capa unida {entitat}"
                        GROUP BY "UTM"
                    ) 
                    AS subquery
                    WHERE "{schema1}"."Capa unida {entitat}"."UTM" = subquery."UTM";
                '''

                cur.execute(sql)
                conn.commit()
            
            else:
                sql = f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_mediana_consum" FLOAT;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" 
                            SET "INDEX_mediana_consum" = 
                                CASE 
                                    WHEN CAST("energia primària no renovable" AS FLOAT) IS NULL OR CAST("energia primària no renovable" AS FLOAT) = 0 THEN NULL
                                    ELSE subquery.median
                                END
                                FROM (
                                    SELECT "id_0",
                                    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("energia primària no renovable" AS FLOAT)) 
                                    AS median FROM "{schema1}"."Capa unida {entitat}"
                                    GROUP BY "id_0"
                                ) 
                            AS subquery
                            WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";\n
                        '''
                sql += f'ALTER TABLE "{schema1}"."Capa unida {entitat}" ADD COLUMN "INDEX_mediana_emissions" FLOAT;\n'
                sql += f'''UPDATE "{schema1}"."Capa unida {entitat}" 
                            SET "INDEX_mediana_emissions" = 
                                CASE 
                                    WHEN CAST("emissions de co2" AS FLOAT) IS NULL OR CAST("emissions de co2" AS FLOAT) = 0 THEN NULL
                                    ELSE subquery.median
                                END
                                FROM (
                                    SELECT "id_0",
                                    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY CAST("emissions de co2" AS FLOAT)) 
                                    AS median FROM "{schema1}"."Capa unida {entitat}"
                                    GROUP BY "id_0"
                                ) 
                            AS subquery
                            WHERE "{schema1}"."Capa unida {entitat}"."id_0" = subquery."id_0";
                        '''
                
                cur.execute(sql)
                conn.commit()
            
        except Exception as ex:
            print ("Error fent mediana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error fent mediana")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
    def dropCapesUnides(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {entitat}";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table if exists de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table if exists de capes unides")
            conn.rollback()
            return
    
    def dropCapesReUnidesNumHabit(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Resum{entitat}RecompteNumHabit";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte NumHabit")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table resum recompte NumHabit")
            conn.rollback()
            return
        
    def dropCapesReUnidesm2(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Resum{entitat}Recomptem2";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte m2")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table resum recompte m2")
            conn.rollback()
            return
        
    def dropCapesReUnidesMitjana(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Resum{entitat}RecompteMitjana";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte mitjana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table resum recompte mitjana")
            conn.rollback()
            return
        
    def dropCapesReUnidesModa(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Resum{entitat}RecompteModa";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte moda")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table resum recompte moda")
            conn.rollback()
            return

    def dropCapesReUnidesMediana(self, entitat):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."Resum{entitat}RecompteMediana";'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error a drop table resum recompte mediana")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a drop table resum recompte mediana")
            conn.rollback()
            return

    def unirCapes(self, entitat, layer):
        global parcel
        global uri

        global parcelLayerJoined
        global illesLayerJoined
        global districtesLayerJoined
        global barrisLayerJoined
        global seccionsLayerJoined

        if entitat==parcel:
            alg_params = {
                "INPUT": layer,
                "FIELD": "UTM",
                "INPUT_2": habitatgesLayer,
                "FIELD_2": "UTM",
                "FIELDS_TO_COPY": ["referencia cadastral", "metres_cadastre", "qualificació de consum energia primaria no renovable", "energia primària no renovable", "qualificacio emissions de co2", "emissions de co2", "producte_con", "producte_emi"],
                "METHOD": 0,
                "OUTPUT": 'memory:'
            }
        else:
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": habitatgesLayer,
                "FIELD_2": f"{entitat}_id",
                "FIELDS_TO_COPY": ["referencia cadastral", "metres_cadastre", "qualificació de consum energia primaria no renovable", "energia primària no renovable", "qualificacio emissions de co2", "emissions de co2", "producte_con", "producte_emi"],
                "METHOD": 0,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)

        capa_unida = result["OUTPUT"]
        layerEntitat = capa_unida
        if not layerEntitat.isValid():
            print("ERROR LAYER UNIT")
            return
        layerEntitat.setName(f"Capa unida {entitat}")
        layerEntitat.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Capa unida {entitat}" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerEntitat.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerEntitat.crs(), overwrite=True)
            exporter.addFeatures(layerEntitat.getFeatures())
            QApplication.processEvents()


        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return

    def carregarCapesMapa(self, entitat):
        global parcelLayerJoined
        global illesLayerJoined
        global districtesLayerJoined
        global barrisLayerJoined
        global seccionsLayerJoined
        
        if entitat==parcel:
            uri.setDataSource(schema1, f"Capa unida {parcel}", 'geom')
            parcelLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {parcel}", 'postgres')
        if entitat==illes:
            uri.setDataSource(schema1, f"Capa unida {illes}", 'geom')
            illesLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {illes}", 'postgres')
        if entitat==districtes:
            uri.setDataSource(schema1, f"Capa unida {districtes}", 'geom')
            districtesLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {districtes}", 'postgres')
        if entitat==barris:
            uri.setDataSource(schema1, f"Capa unida {barris}", 'geom')
            barrisLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {barris}", 'postgres')
        if entitat==seccions:
            uri.setDataSource(schema1, f"Capa unida {seccions}", 'geom')
            seccionsLayerJoined = QgsVectorLayer(uri.uri(), f"Capa unida {seccions}", 'postgres')
        QApplication.processEvents()

    def reUnirCapesNumHabit(self, entitat):
        global parcelLayerResumNumHabit
        global illesLayerResumNumHabit
        global districtesLayerResumNumHabit
        global barrisLayerResumNumHabit
        global seccionsLayerResumNumHabit
        if entitat == parcel:
            layer = parcelLayer
            layerEntitat = parcelLayerJoined
        if entitat == illes:
            layer = illesLayer
            layerEntitat = illesLayerJoined
        if entitat == districtes:
            layer = districtesLayer
            layerEntitat = districtesLayerJoined
        if entitat == barris:
            layer = barrisLayer
            layerEntitat = barrisLayerJoined
        if entitat == seccions:
            layer = seccionsLayer
            layerEntitat = seccionsLayerJoined
        global uri
        if self.dlg.checkNumHabit.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id_0",
                "FIELDS_TO_COPY": ['NumA', 'NumB', 'NumC', 'NumD', 'NumE', 'NumF', 'NumG', 'TotalEE'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Resum{entitat}RecompteNumHabit")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        if entitat == parcel:
            parcelLayerResumNumHabit = layerResum
        if entitat == illes:
            illesLayerResumNumHabit = layerResum
        if entitat == districtes:
            districtesLayerResumNumHabit = layerResum
        if entitat == barris:
            barrisLayerResumNumHabit = layerResum
        if entitat == seccions:
            seccionsLayerResumNumHabit = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Resum{entitat}RecompteNumHabit" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return

    def reUnirCapesm2(self, entitat):
        global parcelLayerResumm2
        global illesLayerResumm2
        global districtesLayerResumm2
        global barrisLayerResumm2
        global seccionsLayerResumm2
        if entitat == parcel:
            layer = parcelLayer
            layerEntitat = parcelLayerJoined
        if entitat == illes:
            layer = illesLayer
            layerEntitat = illesLayerJoined
        if entitat == districtes:
            layer = districtesLayer
            layerEntitat = districtesLayerJoined
        if entitat == barris:
            layer = barrisLayer
            layerEntitat = barrisLayerJoined
        if entitat == seccions:
            layer = seccionsLayer
            layerEntitat = seccionsLayerJoined
        global uri
        if self.dlg.checkm2.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id_0",
                "FIELDS_TO_COPY": ['m2A', 'm2B', 'm2C', 'm2D', 'm2E', 'm2F', 'm2G', 'Totalm2'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Resum{entitat}Recomptem2")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        if entitat == parcel:
            parcelLayerResumm2 = layerResum
        if entitat == illes:
            illesLayerResumm2 = layerResum
        if entitat == districtes:
            districtesLayerResumm2 = layerResum
        if entitat == barris:
            barrisLayerResumm2 = layerResum
        if entitat == seccions:
            seccionsLayerResumm2 = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Resum{entitat}Recomptem2" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return

    def reUnirCapesMitjana(self, entitat):
        global parcelLayerResumMitjana
        global illesLayerResumMitjana
        global districtesLayerResumMitjana
        global barrisLayerResumMitjana
        global seccionsLayerResumMitjana
        if entitat == parcel:
            layer = parcelLayer
            layerEntitat = parcelLayerJoined
        if entitat == illes:
            layer = illesLayer
            layerEntitat = illesLayerJoined
        if entitat == districtes:
            layer = districtesLayer
            layerEntitat = districtesLayerJoined
        if entitat == barris:
            layer = barrisLayer
            layerEntitat = barrisLayerJoined
        if entitat == seccions:
            layer = seccionsLayer
            layerEntitat = seccionsLayerJoined
        global uri
        if self.dlg.checkMitjana.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id_0",
                "FIELDS_TO_COPY": ['INDEX_consum', 'INDEX_emissions'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Resum{entitat}RecompteMitjana")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        if entitat == parcel:
            parcelLayerResumMitjana = layerResum
        if entitat == illes:
            illesLayerResumMitjana = layerResum
        if entitat == districtes:
            districtesLayerResumMitjana = layerResum
        if entitat == barris:
            barrisLayerResumMitjana = layerResum
        if entitat == seccions:
            seccionsLayerResumMitjana = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Resum{entitat}RecompteMitjana" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return
        
    def reUnirCapesModa(self, entitat):
        global parcelLayerResumModa
        global illesLayerResumModa
        global districtesLayerResumModa
        global barrisLayerResumModa
        global seccionsLayerResumModa

        if entitat == parcel:
            layer = parcelLayer
            layerEntitat = parcelLayerJoined
        if entitat == illes:
            layer = illesLayer
            layerEntitat = illesLayerJoined
        if entitat == districtes:
            layer = districtesLayer
            layerEntitat = districtesLayerJoined
        if entitat == barris:
            layer = barrisLayer
            layerEntitat = barrisLayerJoined
        if entitat == seccions:
            layer = seccionsLayer
            layerEntitat = seccionsLayerJoined
        global uri
        if self.dlg.checkModa.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id_0",
                "FIELDS_TO_COPY": ['QualifMaxSup', 'indexMODAsup', 'indexMODAsupPonderat'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Resum{entitat}RecompteModa")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        if entitat == parcel:
            parcelLayerResumModa = layerResum
        if entitat == illes:
            illesLayerResumModa = layerResum
        if entitat == districtes:
            districtesLayerResumModa = layerResum
        if entitat == barris:
            barrisLayerResumModa = layerResum
        if entitat == seccions:
            seccionsLayerResumModa = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Resum{entitat}RecompteModa" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return

    def reUnirCapesMediana(self, entitat):
        global parcelLayerResumMediana
        global illesLayerResumMediana
        global districtesLayerResumMediana
        global barrisLayerResumMediana
        global seccionsLayerResumMediana

        if entitat == parcel:
            layer = parcelLayer
            layerEntitat = parcelLayerJoined
        if entitat == illes:
            layer = illesLayer
            layerEntitat = illesLayerJoined
        if entitat == districtes:
            layer = districtesLayer
            layerEntitat = districtesLayerJoined
        if entitat == barris:
            layer = barrisLayer
            layerEntitat = barrisLayerJoined
        if entitat == seccions:
            layer = seccionsLayer
            layerEntitat = seccionsLayerJoined

        global uri
        if self.dlg.checkMediana.isChecked():
            alg_params = {
                "INPUT": layer,
                "FIELD": "id_0",
                "INPUT_2": layerEntitat,
                "FIELD_2": "id_0",
                "FIELDS_TO_COPY": ['INDEX_mediana_consum', 'INDEX_mediana_emissions'],
                "METHOD": 1,
                "OUTPUT": 'memory:'
            }
        result = processing.run("native:joinattributestable", alg_params)
        resumRecompte = result["OUTPUT"]
        layerResum = resumRecompte
        if not layerResum.isValid():
            print("ERROR RESUM ENTITAT RECOMPTE")
            return
        layerResum.setName(f"Resum{entitat}RecompteMediana")
        layerResum.setCrs(QgsCoordinateReferenceSystem("EPSG:25831"))

        if entitat == parcel:
            parcelLayerResumMediana = layerResum
        if entitat == illes:
            illesLayerResumMediana = layerResum
        if entitat == districtes:
            districtesLayerResumMediana = layerResum
        if entitat == barris:
            barrisLayerResumMediana = layerResum
        if entitat == seccions:
            seccionsLayerResumMediana = layerResum

        try:
            uristr=f"""
            dbname='{nomBD1}' host={host1} port={port1} user='{user1}' password='{password1}' table="{schema1}"."Resum{entitat}RecompteMediana" (geom)
            """
            exporter = QgsVectorLayerExporter(uristr, provider='postgres', fields=layerResum.fields(), geometryType=QgsWkbTypes.MultiPolygon, crs=layerResum.crs(), overwrite=True)
            exporter.addFeatures(layerResum.getFeatures())
            QApplication.processEvents()
        except Exception as ex:
            print ("Error a creació de capes unides")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a creació de capes unides")
            conn.rollback()
            return

    def dropFinalCapesIColumnes(self):
        try:
            sql = f'DROP TABLE IF EXISTS "{schema1}"."{habitatges}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."{parcel}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."{illes}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."{districtes}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."{barris}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."{seccions}_copy";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {parcel}";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{parcel}RecompteNumHabit";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{parcel}Recomptem2";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{parcel}RecompteMitjana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{parcel}RecompteModa";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{parcel}RecompteMediana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {illes}";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{illes}RecompteNumHabit";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{illes}Recomptem2";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{illes}RecompteMitjana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{illes}RecompteModa";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{illes}RecompteMediana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {barris}";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{barris}RecompteNumHabit";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{barris}Recomptem2";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{barris}RecompteMitjana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{barris}RecompteModa";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{barris}RecompteMediana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {districtes}";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{districtes}RecompteNumHabit";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{districtes}Recomptem2";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{districtes}RecompteMitjana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{districtes}RecompteModa";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{districtes}RecompteMediana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Capa unida {seccions}";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{seccions}RecompteNumHabit";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{seccions}Recomptem2";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{seccions}RecompteMitjana";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{seccions}RecompteModa";\n'
            sql += f'DROP TABLE IF EXISTS "{schema1}"."Resum{seccions}RecompteMediana";\n'
            cur.execute(sql)
            conn.commit()
        except Exception as ex:
            print ("Error fent drops finals")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error fent drops finals")
            conn.rollback()
            self.dlg.setEnabled(True)
            return 

    def barraEstat_processant(self):
        '''Aquesta funció canvia l'aparença de la barra d'estat a "Processant..."'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: rgb(255, 125, 155)')
        self.dlg.lblEstatConn.setText("Processant...")
        QApplication.processEvents()
        
    def barraEstat_noConnectat(self):
        '''Aquesta funció canvia l'aparença de la barra d'estat a "No connectat"'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #FFFFFF')
        self.dlg.lblEstatConn.setText('No connectat')
        QApplication.processEvents()
        
    def barraEstat_connectat(self):
        '''Aquesta funció canvia l'aparença de la barra d'estat a "Connectat"'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #7fff7f')
        self.dlg.lblEstatConn.setText('Connectat')
        QApplication.processEvents()
        
    def barraEstat_connectant(self):
        '''Aquesta funció canvia l'aparença de la barra d'estat a "Connectant..."'''
        self.dlg.lblEstatConn.setStyleSheet('border:1px solid #000000; background-color: #ffff7f')
        self.dlg.lblEstatConn.setText('Connectant...')
        QApplication.processEvents()

    def maxTotalEE(self, entitat):
        global conn
        global cur
        sql = f'''SELECT MAX("TotalEE") FROM "{schema1}"."Capa unida {entitat}";'''
        cur.execute(sql)
        return cur.fetchone()[0]

    def maxTotalm2(self, entitat):
        global conn
        global cur
        sql = f'''SELECT MAX("Totalm2"::float) FROM "{schema1}"."Capa unida {entitat}";'''
        cur.execute(sql)
        result = cur.fetchone()[0]
        if (result == None):
            return 0
        else:
            return float(result)

    def on_click_Sortir(self):
        cur.close()
        conn.close()
        self.estatInicial()
        self.dlg.close()

    def on_click_Inici(self):
        global cur
        global conn
        global textBox
        global nomBD1
        global password1
        global host1
        global user1
        global port1
        global schema1
        global uri

        global habitatges
        global habitatgesLayer
        global parcel
        global parcelLayer
        global parcelLayerJoined
        global parcelLayerResumNumHabit
        global parcelLayerResumm2
        global illes
        global illesLayer
        global illesLayerJoined
        global illesLayerResumNumHabit
        global illesLayerResumm2
        global districtes
        global districtesLayer
        global districtesLayerJoined
        global districtesLayerResumNumHabit
        global districtesLayerResumm2
        global barris
        global barrisLayer
        global barrisLayerJoined
        global barrisLayerResumNumHabit
        global barrisLayerResumm2
        global seccions 
        global seccionsLayer
        global seccionsLayerJoined
        global seccionsLayerResumNumHabit
        global seccionsLayerResumm2

        uri = QgsDataSourceUri()
        try:
            uri.setConnection(host1, port1, nomBD1, user1, password1)
        except Exception as ex:
            print ("Error a la connexio")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "Error a la connexio")
            conn.rollback()
            self.dlg.setEnabled(True)
            return

        if habitatges == None or habitatges=='Selecciona els habitatges':
            self.dlg.setEnabled(True)
            print ("No s'ha seleccionat cap habitici")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "No s'ha seleccionat cap habitici")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        global textBox
        self.dlg.setEnabled(False)
        self.dlg.groupBD.setEnabled(False)
        self.dlg.groupChecks.setEnabled(False)
        self.dlg.groupEntitats.setEnabled(False)
        textBox += f"\nINICIANT EL PROCÉS...\n"
        print("Comença programa")
        self.dlg.textEstat.setText(textBox)
        
        '''Control exceptions'''

        if (not self.dlg.checkNumHabit.isChecked() and not self.dlg.checkm2.isChecked() and not self.dlg.checkMitjana.isChecked() and not self.dlg.checkModa.isChecked() and not self.dlg.checkMediana.isChecked()):
            self.dlg.setEnabled(True)
            print ("No s'ha seleccionat cap operació que realitzar")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "No s'ha seleccionat cap operació que realitzar")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        if (not self.dlg.checkBarris.isChecked() and not self.dlg.checkDistrictes.isChecked() and not self.dlg.checkIlles.isChecked() and not self.dlg.checkParcel.isChecked() and not self.dlg.checkSeccions.isChecked()):
            self.dlg.setEnabled(True)
            print ("No s'ha seleccionat cap entitat amb la que treballar")
            template = "An exception of type {0} occurred. Arguments:\n{1!r}"
            message = template.format(type(ex).__name__, ex.args)
            print (message)
            QMessageBox.information(None, "Error", "No s'ha seleccionat cap entitat amb la que treballar")
            conn.rollback()
            self.dlg.setEnabled(True)
            return
        
        print("No hi ha excepcions")
        ''' Crear copies capes originals '''
        self.crearCopiesCapesEntitats(habitatges)
        if (self.dlg.checkParcel.isChecked()):
            self.crearCopiesCapesEntitats(parcel)
        if (self.dlg.checkIlles.isChecked()):
            self.crearCopiesCapesEntitats(illes)
        if (self.dlg.checkDistrictes.isChecked()):
            self.crearCopiesCapesEntitats(districtes)
        if (self.dlg.checkBarris.isChecked()):
            self.crearCopiesCapesEntitats(barris)
        if (self.dlg.checkSeccions.isChecked()):
            self.crearCopiesCapesEntitats(seccions)
        QApplication.processEvents()
        print("Fetes copies de les capes originals")

        ''' IDs Entitats '''

        textBox += f"Calculant ID d'entitats seleccionades...\n"
        self.dlg.textEstat.setText(textBox)
        self.calcularCampsHabitatges()
        self.crearIDentitats()
        QApplication.processEvents()
        print("Fetes IDs de les entitats")

        ''' Unió capes '''

        textBox += f"Unint capes seleccionades...\n"
        self.dlg.textEstat.setText(textBox)
        if(self.dlg.checkParcel.isChecked()):
            self.dropCapesUnides(parcel)
            self.unirCapes(parcel, parcelLayer)
            print("Drop i unio parcel")
        if(self.dlg.checkIlles.isChecked()):
            self.dropCapesUnides(illes)
            self.unirCapes(illes, illesLayer)
            print("Drop i unio illes")
        if(self.dlg.checkDistrictes.isChecked()):
            self.dropCapesUnides(districtes)
            self.unirCapes(districtes, districtesLayer)
            print("Drop i unio districtes")
        if(self.dlg.checkBarris.isChecked()):
            self.dropCapesUnides(barris)
            self.unirCapes(barris, barrisLayer)
            print("Drop i unio barris")
        if(self.dlg.checkSeccions.isChecked()):
            self.dropCapesUnides(seccions)
            self.unirCapes(seccions, seccionsLayer)
            print("Drop i unio seccions")
        QApplication.processEvents()
        
        ''' Processament càlculs '''

        'NumX habitatges per entitats'

        if(self.dlg.checkNumHabit.isChecked()):
            textBox += f"Calculant NumX d'habitatges...\n"
            self.dlg.textEstat.setText(textBox)
            if(self.dlg.checkParcel.isChecked()):
                self.calculNumX(parcel)
                print("Calcul NumX parcel")
            if(self.dlg.checkIlles.isChecked()):
                self.calculNumX(illes)
                print("Calcul NumX illes")
            if(self.dlg.checkDistrictes.isChecked()):
                self.calculNumX(districtes)
                print("Calcul NumX districtes")
            if(self.dlg.checkBarris.isChecked()):
                self.calculNumX(barris)
                print("Calcul NumX barris")
            if(self.dlg.checkSeccions.isChecked()):
                self.calculNumX(seccions)
                print("Calcul NumX seccions")
            QApplication.processEvents()
        
        'm2 habitatges per entitats'
        
        if(self.dlg.checkm2.isChecked()):
            textBox += f"Calculant m2 d'habitatges...\n"
            self.dlg.textEstat.setText(textBox)
            if(self.dlg.checkParcel.isChecked()):
                self.calculm2(parcel)
                print("Calcul m2 parcel")
            if(self.dlg.checkIlles.isChecked()):
                self.calculm2(illes)
                print("Calcul m2 illes")
            if(self.dlg.checkDistrictes.isChecked()):
                self.calculm2(districtes)
                print("Calcul m2 districtes")
            if(self.dlg.checkBarris.isChecked()):
                self.calculm2(barris)
                print("Calcul m2 barris")
            if(self.dlg.checkSeccions.isChecked()):
                self.calculm2(seccions)
                print("Calcul m2 seccions")
            QApplication.processEvents()    
        
        'Mitjana habitatges per entitats'

        if self.dlg.checkMitjana.isChecked():
            textBox += f"Calculant mitjana de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            if self.dlg.checkParcel.isChecked():
                self.calculMitjana(parcel)
                print("Calcul mitjana parcel")
            if self.dlg.checkIlles.isChecked():
                self.calculMitjana(illes)
                print("Calcul mitjana illes")
            if self.dlg.checkDistrictes.isChecked():
                self.calculMitjana(districtes)
                print("Calcul mitjana districtes")
            if self.dlg.checkBarris.isChecked():
                self.calculMitjana(barris)
                print("Calcul mitjana barris")
            if self.dlg.checkSeccions.isChecked():
                self.calculMitjana(seccions)
                print("Calcul mitjana seccions")
            QApplication.processEvents()

        'Moda habitatges per entitats'

        if self.dlg.checkModa.isChecked():
            textBox += f"Calculant moda de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            if self.dlg.checkParcel.isChecked():
                self.calculModa(parcel)
                print("Calcul moda parcel")
            if self.dlg.checkIlles.isChecked():
                self.calculModa(illes)
                print("Calcul moda illes")
            if self.dlg.checkDistrictes.isChecked():
                self.calculModa(districtes)
                print("Calcul moda districtes")
            if self.dlg.checkBarris.isChecked():
                self.calculModa(barris)
                print("Calcul moda barris")
            if self.dlg.checkSeccions.isChecked():
                self.calculModa(seccions)
                print("Calcul moda seccions")
            QApplication.processEvents()

        'Mediana habitatges per entitats'

        if self.dlg.checkMediana.isChecked():
            textBox += f"Calculant mediana de consum i emissions d'habitatges per entitats...\n"
            self.dlg.textEstat.setText(textBox)
            if self.dlg.checkParcel.isChecked():
                self.calculMediana(parcel)
                print("Calcul mediana parcel")
            if self.dlg.checkIlles.isChecked():
                self.calculMediana(illes)
                print("Calcul mediana illes")
            if self.dlg.checkDistrictes.isChecked():
                self.calculMediana(districtes)
                print("Calcul mediana districtes")
            if self.dlg.checkBarris.isChecked():
                self.calculMediana(barris)
                print("Calcul mediana barris")
            if self.dlg.checkSeccions.isChecked():
                self.calculMediana(seccions)
                print("Calcul mediana seccions")
            QApplication.processEvents()


        'Carregar capes, fer drops i tornar a unir-les per alleugerir-les'
        'per NumHabit'

        if self.dlg.checkNumHabit.isChecked():
            if self.dlg.checkParcel.isChecked():
                self.carregarCapesMapa(parcel)
                print("Carregada al mapa la capa parcel")
                self.dropCapesReUnidesNumHabit(parcel)
                print("Fet el drop per si de cas de capes re unides num habit parcel")
                self.reUnirCapesNumHabit(parcel)
                print("Re unides num habit parcel")
            if self.dlg.checkIlles.isChecked():
                self.carregarCapesMapa(illes)
                print("Carregada al mapa la capa illes")
                self.dropCapesReUnidesNumHabit(illes)
                print("Fet el drop per si de cas de capes re unides num habit illes")
                self.reUnirCapesNumHabit(illes)
                print("Re unides num habit illes")
            if self.dlg.checkDistrictes.isChecked():
                self.carregarCapesMapa(districtes)
                print("Carregada al mapa la capa districtes")
                self.dropCapesReUnidesNumHabit(districtes)
                print("Fet el drop per si de cas de capes re unides num habit districtes")
                self.reUnirCapesNumHabit(districtes)
                print("Re unides num habit districtes")
            if self.dlg.checkBarris.isChecked():
                self.carregarCapesMapa(barris)
                print("Carregada al mapa la capa barris")
                self.dropCapesReUnidesNumHabit(barris)
                print("Fet el drop per si de cas de capes re unides num habit barris")
                self.reUnirCapesNumHabit(barris)
                print("Re unides num habit barris")
            if self.dlg.checkSeccions.isChecked():
                self.carregarCapesMapa(seccions)
                print("Carregada al mapa la capa seccions")
                self.dropCapesReUnidesNumHabit(seccions)
                print("Fet el drop per si de cas de capes re unides num habit seccions")
                self.reUnirCapesNumHabit(seccions)
                print("Re unides num habit seccions")
            QApplication.processEvents()      
        
        'per m2'

        if self.dlg.checkm2.isChecked():
            if self.dlg.checkParcel.isChecked():
                self.carregarCapesMapa(parcel)
                print("Carregada al mapa la capa parcel")
                self.dropCapesReUnidesm2(parcel)
                print("Fet el drop per si de cas de capes re unides m2 parcel")
                self.reUnirCapesm2(parcel)
                print("Re unides m2 parcel")
            if self.dlg.checkIlles.isChecked():
                self.carregarCapesMapa(illes)
                print("Carregada al mapa la capa illes")
                self.dropCapesReUnidesm2(illes)
                print("Fet el drop per si de cas de capes re unides m2 illes")
                self.reUnirCapesm2(illes)
                print("Re unides m2 illes")
            if self.dlg.checkDistrictes.isChecked():
                self.carregarCapesMapa(districtes)
                print("Carregada al mapa la capa districtes")
                self.dropCapesReUnidesm2(districtes)
                print("Fet el drop per si de cas de capes re unides m2 districtes")
                self.reUnirCapesm2(districtes)
                print("Re unides m2 districtes")
            if self.dlg.checkBarris.isChecked():
                self.carregarCapesMapa(barris)
                print("Carregada al mapa la capa barris")
                self.dropCapesReUnidesm2(barris)
                print("Fet el drop per si de cas de capes re unides m2 barris")
                self.reUnirCapesm2(barris)
                print("Re unides m2 barris")
            if self.dlg.checkSeccions.isChecked():
                self.carregarCapesMapa(seccions)
                print("Carregada al mapa la capa seccions")
                self.dropCapesReUnidesm2(seccions)
                print("Fet el drop per si de cas de capes re unides m2 seccions")
                self.reUnirCapesm2(seccions)
                print("Re unides m2 seccions")
        QApplication.processEvents()

        'per mitjana'
        if self.dlg.checkMitjana.isChecked():
            if self.dlg.checkParcel.isChecked():
                self.carregarCapesMapa(parcel)
                self.dropCapesReUnidesMitjana(parcel)
                self.reUnirCapesMitjana(parcel)
            if self.dlg.checkIlles.isChecked():
                self.carregarCapesMapa(illes)
                self.dropCapesReUnidesMitjana(illes)
                self.reUnirCapesMitjana(illes)
            if self.dlg.checkDistrictes.isChecked():
                self.carregarCapesMapa(districtes)
                self.dropCapesReUnidesMitjana(districtes)
                self.reUnirCapesMitjana(districtes)
            if self.dlg.checkBarris.isChecked():
                self.carregarCapesMapa(barris)
                self.dropCapesReUnidesMitjana(barris)
                self.reUnirCapesMitjana(barris)
            if self.dlg.checkSeccions.isChecked():
                self.carregarCapesMapa(seccions)
                self.dropCapesReUnidesMitjana(seccions)
                self.reUnirCapesMitjana(seccions)
        QApplication.processEvents()

        'per moda'

        if self.dlg.checkModa.isChecked():
            if self.dlg.checkParcel.isChecked():
                self.carregarCapesMapa(parcel)
                self.dropCapesReUnidesModa(parcel)
                self.reUnirCapesModa(parcel)
            if self.dlg.checkIlles.isChecked():
                self.carregarCapesMapa(illes)
                self.dropCapesReUnidesModa(illes)
                self.reUnirCapesModa(illes)
            if self.dlg.checkDistrictes.isChecked():
                self.carregarCapesMapa(districtes)
                self.dropCapesReUnidesModa(districtes)
                self.reUnirCapesModa(districtes)
            if self.dlg.checkBarris.isChecked():
                self.carregarCapesMapa(barris)
                self.dropCapesReUnidesModa(barris)
                self.reUnirCapesModa(barris)
            if self.dlg.checkSeccions.isChecked():
                self.carregarCapesMapa(seccions)
                self.dropCapesReUnidesModa(seccions)
                self.reUnirCapesModa(seccions)
        QApplication.processEvents()

        'per mediana'

        if self.dlg.checkMediana.isChecked():
            if self.dlg.checkParcel.isChecked():
                self.carregarCapesMapa(parcel)
                self.dropCapesReUnidesMediana(parcel)
                self.reUnirCapesMediana(parcel)
            if self.dlg.checkIlles.isChecked():
                self.carregarCapesMapa(illes)
                self.dropCapesReUnidesMediana(illes)
                self.reUnirCapesMediana(illes)
            if self.dlg.checkDistrictes.isChecked():
                self.carregarCapesMapa(districtes)
                self.dropCapesReUnidesMediana(districtes)
                self.reUnirCapesMediana(districtes)
            if self.dlg.checkBarris.isChecked():
                self.carregarCapesMapa(barris)
                self.dropCapesReUnidesMediana(barris)
                self.reUnirCapesMediana(barris)
            if self.dlg.checkSeccions.isChecked():
                self.carregarCapesMapa(seccions)
                self.dropCapesReUnidesMediana(seccions)
                self.reUnirCapesMediana(seccions)
        QApplication.processEvents()

        ''' Diagrames de pie chart '''

        NumDiagramColors = {
            'NumA': QColor.fromCmykF(0.85, 0.15, 0.95, 0.30),
            'NumB': QColor.fromCmykF(0.80, 0.00, 1.00, 0.00),
            'NumC': QColor.fromCmykF(0.45, 0.00, 1.00, 0.00),
            'NumD': QColor.fromCmykF(0.10, 0.00, 0.95, 0.00),
            'NumE': QColor.fromCmykF(0.05, 0.30, 1.00, 0.00),
            'NumF': QColor.fromCmykF(0.10, 0.65, 1.00, 0.00),
            'NumG': QColor.fromCmykF(0.05, 0.95, 0.95, 0.00)
        }

        m2DiagramColors = {
            'm2A': QColor.fromCmykF(0.85, 0.15, 0.95, 0.30),
            'm2B': QColor.fromCmykF(0.80, 0.00, 1.00, 0.00),
            'm2C': QColor.fromCmykF(0.45, 0.00, 1.00, 0.00),
            'm2D': QColor.fromCmykF(0.10, 0.00, 0.95, 0.00),
            'm2E': QColor.fromCmykF(0.05, 0.30, 1.00, 0.00),
            'm2F': QColor.fromCmykF(0.10, 0.65, 1.00, 0.00),
            'm2G': QColor.fromCmykF(0.05, 0.95, 0.95, 0.00)
        }

        if self.dlg.checkParcel.isChecked():
            if self.dlg.checkNumHabit.isChecked():
                uri.setDataSource(schema1, f"Resum{parcel}RecompteNumHabit", 'geom')
                capaUnidaParcelNumHabit = QgsVectorLayer(uri.uri(), f"Resum{parcel}RecompteNumHabit", 'postgres')
                capaUnidaParcelNumHabit_temp_features = [feat for feat in capaUnidaParcelNumHabit.getFeatures()]
                capaUnidaParcelNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{parcel}RecompteNumHabit", "memory")
                capaUnidaParcelNumHabit_temp_data = capaUnidaParcelNumHabit_temp.dataProvider()
                attributes = capaUnidaParcelNumHabit.dataProvider().fields().toList()
                capaUnidaParcelNumHabit_temp_data.addAttributes(attributes)
                capaUnidaParcelNumHabit_temp.updateFields()
                capaUnidaParcelNumHabit_temp_data.addFeatures(capaUnidaParcelNumHabit_temp_features)
                if capaUnidaParcelNumHabit_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaParcelNumHabit_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de parcel de numhabit")
                
                parcelDiagramNumHabit = QgsPieDiagram()
                parcelDiagramNumHabitSettings = QgsDiagramSettings()
                parcelDiagramNumHabitSettings.categoryColors = NumDiagramColors.values()
                parcelDiagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
                parcelDiagramNumHabitSettings.scaleByArea = True
                parcelDiagramNumHabitSettings.categoryLabels = parcelDiagramNumHabitSettings.categoryAttributes

                parcelDiagramNumHabitRenderer = QgsLinearlyInterpolatedDiagramRenderer()
                parcelDiagramNumHabitRenderer.setLowerValue(0)
                parcelDiagramNumHabitRenderer.setLowerSize(QSizeF(0, 0))
                parcelDiagramNumHabitRenderer.setUpperValue(self.maxTotalEE(parcel))
                parcelDiagramNumHabitRenderer.setUpperSize(QSizeF(30, 30))
                parcelDiagramNumHabitRenderer.setClassificationField("TotalEE")
                parcelDiagramNumHabitRenderer.setDiagram(parcelDiagramNumHabit)
                parcelDiagramNumHabitRenderer.setDiagramSettings(parcelDiagramNumHabitSettings)
                
                capaUnidaParcelNumHabit_temp.setDiagramRenderer(parcelDiagramNumHabitRenderer)
                parcelDiagramNumHabitLayerSettings = QgsDiagramLayerSettings()

                capaUnidaParcelNumHabit_temp.setDiagramLayerSettings(parcelDiagramNumHabitLayerSettings)
                capaUnidaParcelNumHabit_temp.triggerRepaint()
                QApplication.processEvents()

            if self.dlg.checkm2.isChecked():
                uri.setDataSource(schema1, f"Resum{parcel}Recomptem2", 'geom')
                capaUnidaParcelm2 = QgsVectorLayer(uri.uri(), f"Resum{parcel}Recomptem2", 'postgres')
                capaUnidaParcelm2_temp_features = [feat for feat in capaUnidaParcelm2.getFeatures()]
                capaUnidaParcelm2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{parcel}Recomptem2", "memory")
                capaUnidaParcelm2_temp_data = capaUnidaParcelm2_temp.dataProvider()
                attributes = capaUnidaParcelm2.dataProvider().fields().toList()
                capaUnidaParcelm2_temp_data.addAttributes(attributes)
                capaUnidaParcelm2_temp.updateFields()
                capaUnidaParcelm2_temp_data.addFeatures(capaUnidaParcelm2_temp_features)
                if capaUnidaParcelm2_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaParcelm2_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de parcel de m2")

                parcelDiagramm2 = QgsPieDiagram()
                parcelDiagramm2Settings = QgsDiagramSettings()
                parcelDiagramm2Settings.categoryColors = m2DiagramColors.values()
                parcelDiagramm2Settings.categoryAttributes = m2DiagramColors.keys()
                parcelDiagramm2Settings.scaleByArea = True
                parcelDiagramm2Settings.categoryLabels = parcelDiagramm2Settings.categoryAttributes

                parcelDiagramm2Renderer = QgsLinearlyInterpolatedDiagramRenderer()
                parcelDiagramm2Renderer.setLowerValue(0)
                parcelDiagramm2Renderer.setLowerSize(QSizeF(0, 0))
                maxm2 = self.maxTotalm2(parcel)
                parcelDiagramm2Renderer.setUpperValue(maxm2)
                parcelDiagramm2Renderer.setUpperSize(QSizeF(100, 100))
                parcelDiagramm2Renderer.setClassificationField("Totalm2")
                parcelDiagramm2Renderer.setDiagram(parcelDiagramm2)
                parcelDiagramm2Renderer.setDiagramSettings(parcelDiagramm2Settings)
                
                capaUnidaParcelm2_temp.setDiagramRenderer(parcelDiagramm2Renderer)
                parcelDiagramm2LayerSettings = QgsDiagramLayerSettings()

                capaUnidaParcelm2_temp.setDiagramLayerSettings(parcelDiagramm2LayerSettings)
                capaUnidaParcelm2_temp.triggerRepaint()
                QApplication.processEvents()

        if(self.dlg.checkIlles.isChecked()):
            if self.dlg.checkNumHabit.isChecked():
                uri.setDataSource(schema1, f"Resum{illes}RecompteNumHabit", 'geom')
                capaUnidaillesNumHabit = QgsVectorLayer(uri.uri(), f"Resum{illes}RecompteNumHabit", 'postgres')
                capaUnidaillesNumHabit_temp_features = [feat for feat in capaUnidaillesNumHabit.getFeatures()]
                capaUnidaillesNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{illes}RecompteNumHabit", "memory")
                capaUnidaillesNumHabit_temp_data = capaUnidaillesNumHabit_temp.dataProvider()
                attributes = capaUnidaillesNumHabit.dataProvider().fields().toList()
                capaUnidaillesNumHabit_temp_data.addAttributes(attributes)
                capaUnidaillesNumHabit_temp.updateFields()
                capaUnidaillesNumHabit_temp_data.addFeatures(capaUnidaillesNumHabit_temp_features)
                if capaUnidaillesNumHabit_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaillesNumHabit_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de illes de numhabit")

                illesDiagramNumHabit = QgsPieDiagram()
                illesDiagramNumHabitSettings = QgsDiagramSettings()
                illesDiagramNumHabitSettings.categoryColors = NumDiagramColors.values()
                illesDiagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
                illesDiagramNumHabitSettings.scaleByArea = True
                illesDiagramNumHabitSettings.categoryLabels = illesDiagramNumHabitSettings.categoryAttributes

                illesDiagramNumHabitRenderer = QgsLinearlyInterpolatedDiagramRenderer()
                illesDiagramNumHabitRenderer.setLowerValue(0)
                illesDiagramNumHabitRenderer.setLowerSize(QSizeF(0, 0))
                illesDiagramNumHabitRenderer.setUpperValue(self.maxTotalEE(illes))
                illesDiagramNumHabitRenderer.setUpperSize(QSizeF(50, 50))
                illesDiagramNumHabitRenderer.setClassificationField("TotalEE")
                illesDiagramNumHabitRenderer.setDiagram(illesDiagramNumHabit)
                illesDiagramNumHabitRenderer.setDiagramSettings(illesDiagramNumHabitSettings)
                
                capaUnidaillesNumHabit_temp.setDiagramRenderer(illesDiagramNumHabitRenderer)
                illesDiagramNumHabitLayerSettings = QgsDiagramLayerSettings()

                capaUnidaillesNumHabit_temp.setDiagramLayerSettings(illesDiagramNumHabitLayerSettings)
                capaUnidaillesNumHabit_temp.triggerRepaint()
                QApplication.processEvents()

            if self.dlg.checkm2.isChecked():
                uri.setDataSource(schema1, f"Resum{illes}Recomptem2", 'geom')
                capaUnidaillesm2 = QgsVectorLayer(uri.uri(), f"Resum{illes}Recomptem2", 'postgres')
                capaUnidaillesm2_temp_features = [feat for feat in capaUnidaillesm2.getFeatures()]
                capaUnidaillesm2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{illes}Recomptem2", "memory")
                capaUnidaillesm2_temp_data = capaUnidaillesm2_temp.dataProvider()
                attributes = capaUnidaillesm2.dataProvider().fields().toList()
                capaUnidaillesm2_temp_data.addAttributes(attributes)
                capaUnidaillesm2_temp.updateFields()
                capaUnidaillesm2_temp_data.addFeatures(capaUnidaillesm2_temp_features)
                if capaUnidaillesm2_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaillesm2_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de illes de m2")

                illesDiagramm2 = QgsPieDiagram()
                illesDiagramm2Settings = QgsDiagramSettings()
                illesDiagramm2Settings.categoryColors = m2DiagramColors.values()
                illesDiagramm2Settings.categoryAttributes = m2DiagramColors.keys()
                illesDiagramm2Settings.scaleByArea = True
                illesDiagramm2Settings.categoryLabels = illesDiagramm2Settings.categoryAttributes

                illesDiagramm2Renderer = QgsLinearlyInterpolatedDiagramRenderer()
                illesDiagramm2Renderer.setLowerValue(0)
                illesDiagramm2Renderer.setLowerSize(QSizeF(0, 0))
                maxm2 = self.maxTotalm2(illes)
                illesDiagramm2Renderer.setUpperValue(maxm2)
                illesDiagramm2Renderer.setUpperSize(QSizeF(50, 50))
                illesDiagramm2Renderer.setClassificationField("Totalm2")
                illesDiagramm2Renderer.setDiagram(illesDiagramm2)
                illesDiagramm2Renderer.setDiagramSettings(illesDiagramm2Settings)
                
                capaUnidaillesm2_temp.setDiagramRenderer(illesDiagramm2Renderer)
                illesDiagramm2LayerSettings = QgsDiagramLayerSettings()

                capaUnidaillesm2_temp.setDiagramLayerSettings(illesDiagramm2LayerSettings)
                capaUnidaillesm2_temp.triggerRepaint()
                QApplication.processEvents()

        if self.dlg.checkDistrictes.isChecked():
            if self.dlg.checkNumHabit.isChecked():
                uri.setDataSource(schema1, f"Resum{districtes}RecompteNumHabit", 'geom')
                capaUnidadistrictesNumHabit = QgsVectorLayer(uri.uri(), f"Resum{districtes}RecompteNumHabit", 'postgres')
                capaUnidadistrictesNumHabit_temp_features = [feat for feat in capaUnidadistrictesNumHabit.getFeatures()]
                capaUnidadistrictesNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{districtes}RecompteNumHabit", "memory")
                capaUnidadistrictesNumHabit_temp_data = capaUnidadistrictesNumHabit_temp.dataProvider()
                attributes = capaUnidadistrictesNumHabit.dataProvider().fields().toList()
                capaUnidadistrictesNumHabit_temp_data.addAttributes(attributes)
                capaUnidadistrictesNumHabit_temp.updateFields()
                capaUnidadistrictesNumHabit_temp_data.addFeatures(capaUnidadistrictesNumHabit_temp_features)
                if capaUnidadistrictesNumHabit_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidadistrictesNumHabit_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de districtes de numhabit")

                districtesDiagramNumHabit = QgsPieDiagram()
                districtesDiagramNumHabitSettings = QgsDiagramSettings()
                districtesDiagramNumHabitSettings.categoryColors = NumDiagramColors.values()
                districtesDiagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
                districtesDiagramNumHabitSettings.scaleByArea = True
                districtesDiagramNumHabitSettings.categoryLabels = districtesDiagramNumHabitSettings.categoryAttributes

                districtesDiagramNumHabitRenderer = QgsLinearlyInterpolatedDiagramRenderer()
                districtesDiagramNumHabitRenderer.setLowerValue(0)
                districtesDiagramNumHabitRenderer.setLowerSize(QSizeF(0, 0))
                districtesDiagramNumHabitRenderer.setUpperValue(self.maxTotalEE(districtes))
                districtesDiagramNumHabitRenderer.setUpperSize(QSizeF(30, 30))
                districtesDiagramNumHabitRenderer.setClassificationField("TotalEE")
                districtesDiagramNumHabitRenderer.setDiagram(districtesDiagramNumHabit)
                districtesDiagramNumHabitRenderer.setDiagramSettings(districtesDiagramNumHabitSettings)
                
                capaUnidadistrictesNumHabit_temp.setDiagramRenderer(districtesDiagramNumHabitRenderer)
                districtesDiagramNumHabitLayerSettings = QgsDiagramLayerSettings()

                capaUnidadistrictesNumHabit_temp.setDiagramLayerSettings(districtesDiagramNumHabitLayerSettings)
                capaUnidadistrictesNumHabit_temp.triggerRepaint()
                QApplication.processEvents()

            if self.dlg.checkm2.isChecked():
                uri.setDataSource(schema1, f"Resum{districtes}Recomptem2", 'geom')
                capaUnidadistrictesm2 = QgsVectorLayer(uri.uri(), f"Resum{districtes}Recomptem2", 'postgres')
                capaUnidadistrictesm2_temp_features = [feat for feat in capaUnidadistrictesm2.getFeatures()]
                capaUnidadistrictesm2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{districtes}Recomptem2", "memory")
                capaUnidadistrictesm2_temp_data = capaUnidadistrictesm2_temp.dataProvider()
                attributes = capaUnidadistrictesm2.dataProvider().fields().toList()
                capaUnidadistrictesm2_temp_data.addAttributes(attributes)
                capaUnidadistrictesm2_temp.updateFields()
                capaUnidadistrictesm2_temp_data.addFeatures(capaUnidadistrictesm2_temp_features)
                if capaUnidadistrictesm2_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidadistrictesm2_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de districtes de numhabit")

                districtesDiagramm2 = QgsPieDiagram()
                districtesDiagramm2Settings = QgsDiagramSettings()
                districtesDiagramm2Settings.categoryColors = m2DiagramColors.values()
                districtesDiagramm2Settings.categoryAttributes = m2DiagramColors.keys()
                districtesDiagramm2Settings.scaleByArea = True
                districtesDiagramm2Settings.categoryLabels = districtesDiagramm2Settings.categoryAttributes

                districtesDiagramm2Renderer = QgsLinearlyInterpolatedDiagramRenderer()
                districtesDiagramm2Renderer.setLowerValue(0)
                districtesDiagramm2Renderer.setLowerSize(QSizeF(0, 0))
                maxm2 = self.maxTotalm2(districtes)
                districtesDiagramm2Renderer.setUpperValue(maxm2)
                districtesDiagramm2Renderer.setUpperSize(QSizeF(30, 30))
                districtesDiagramm2Renderer.setClassificationField("Totalm2")
                districtesDiagramm2Renderer.setDiagram(districtesDiagramm2)
                districtesDiagramm2Renderer.setDiagramSettings(districtesDiagramm2Settings)
                
                capaUnidadistrictesm2_temp.setDiagramRenderer(districtesDiagramm2Renderer)
                districtesDiagramm2LayerSettings = QgsDiagramLayerSettings()

                capaUnidadistrictesm2_temp.setDiagramLayerSettings(districtesDiagramm2LayerSettings)
                capaUnidadistrictesm2_temp.triggerRepaint()
                QApplication.processEvents()

        if self.dlg.checkBarris.isChecked():
            if self.dlg.checkNumHabit.isChecked():
                uri.setDataSource(schema1, f"Resum{barris}RecompteNumHabit", 'geom')
                capaUnidabarrisNumHabit = QgsVectorLayer(uri.uri(), f"Resum{barris}RecompteNumHabit", 'postgres')
                capaUnidabarrisNumHabit_temp_features = [feat for feat in capaUnidabarrisNumHabit.getFeatures()]
                capaUnidabarrisNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{barris}RecompteNumHabit", "memory")
                capaUnidabarrisNumHabit_temp_data = capaUnidabarrisNumHabit_temp.dataProvider()
                attributes = capaUnidabarrisNumHabit.dataProvider().fields().toList()
                capaUnidabarrisNumHabit_temp_data.addAttributes(attributes)
                capaUnidabarrisNumHabit_temp.updateFields()
                capaUnidabarrisNumHabit_temp_data.addFeatures(capaUnidabarrisNumHabit_temp_features)
                if capaUnidabarrisNumHabit_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidabarrisNumHabit_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de districtes de numhabit")

                barrisDiagramNumHabit = QgsPieDiagram()
                barrisDiagramNumHabitSettings = QgsDiagramSettings()
                barrisDiagramNumHabitSettings.categoryColors = NumDiagramColors.values()
                barrisDiagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
                barrisDiagramNumHabitSettings.scaleByArea = True
                barrisDiagramNumHabitSettings.categoryLabels = barrisDiagramNumHabitSettings.categoryAttributes

                barrisDiagramNumHabitRenderer = QgsLinearlyInterpolatedDiagramRenderer()
                barrisDiagramNumHabitRenderer.setLowerValue(0)
                barrisDiagramNumHabitRenderer.setLowerSize(QSizeF(0, 0))
                barrisDiagramNumHabitRenderer.setUpperValue(self.maxTotalEE(barris))
                barrisDiagramNumHabitRenderer.setUpperSize(QSizeF(30, 30))
                barrisDiagramNumHabitRenderer.setClassificationField("TotalEE")
                barrisDiagramNumHabitRenderer.setDiagram(barrisDiagramNumHabit)
                barrisDiagramNumHabitRenderer.setDiagramSettings(barrisDiagramNumHabitSettings)
                
                capaUnidabarrisNumHabit_temp.setDiagramRenderer(barrisDiagramNumHabitRenderer)
                barrisDiagramNumHabitLayerSettings = QgsDiagramLayerSettings()

                capaUnidabarrisNumHabit_temp.setDiagramLayerSettings(barrisDiagramNumHabitLayerSettings)
                capaUnidabarrisNumHabit_temp.triggerRepaint()
                QApplication.processEvents()

            if self.dlg.checkm2.isChecked():
                uri.setDataSource(schema1, f"Resum{barris}Recomptem2", 'geom')
                capaUnidabarrism2 = QgsVectorLayer(uri.uri(), f"Resum{barris}Recomptem2", 'postgres')
                capaUnidabarrism2_temp_features = [feat for feat in capaUnidabarrism2.getFeatures()]
                capaUnidabarrism2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{barris}Recomptem2", "memory")
                capaUnidabarrism2_temp_data = capaUnidabarrism2_temp.dataProvider()
                attributes = capaUnidabarrism2.dataProvider().fields().toList()
                capaUnidabarrism2_temp_data.addAttributes(attributes)
                capaUnidabarrism2_temp.updateFields()
                capaUnidabarrism2_temp_data.addFeatures(capaUnidabarrism2_temp_features)
                if capaUnidabarrism2_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidabarrism2_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de districtes de numhabit")

                barrisDiagramm2 = QgsPieDiagram()
                barrisDiagramm2Settings = QgsDiagramSettings()
                barrisDiagramm2Settings.categoryColors = m2DiagramColors.values()
                barrisDiagramm2Settings.categoryAttributes = m2DiagramColors.keys()
                barrisDiagramm2Settings.scaleByArea = True
                barrisDiagramm2Settings.categoryLabels = barrisDiagramm2Settings.categoryAttributes

                barrisDiagramm2Renderer = QgsLinearlyInterpolatedDiagramRenderer()
                barrisDiagramm2Renderer.setLowerValue(0)
                barrisDiagramm2Renderer.setLowerSize(QSizeF(0, 0))
                maxm2 = self.maxTotalm2(barris)
                barrisDiagramm2Renderer.setUpperValue(maxm2)
                barrisDiagramm2Renderer.setUpperSize(QSizeF(30, 30))
                barrisDiagramm2Renderer.setClassificationField("Totalm2")
                barrisDiagramm2Renderer.setDiagram(barrisDiagramm2)
                barrisDiagramm2Renderer.setDiagramSettings(barrisDiagramm2Settings)
                
                capaUnidabarrism2_temp.setDiagramRenderer(barrisDiagramm2Renderer)
                barrisDiagramm2LayerSettings = QgsDiagramLayerSettings()

                capaUnidabarrism2_temp.setDiagramLayerSettings(barrisDiagramm2LayerSettings)
                capaUnidabarrism2_temp.triggerRepaint()
                QApplication.processEvents()

        if self.dlg.checkSeccions.isChecked():
            if self.dlg.checkNumHabit.isChecked():
                uri.setDataSource(schema1, f"Resum{seccions}RecompteNumHabit", 'geom')
                capaUnidaSeccionsNumHabit = QgsVectorLayer(uri.uri(), f"Resum{seccions}RecompteNumHabit", 'postgres')
                capaUnidaSeccionsNumHabit_temp_features = [feat for feat in capaUnidaSeccionsNumHabit.getFeatures()]
                capaUnidaSeccionsNumHabit_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{seccions}RecompteNumHabit", "memory")
                capaUnidaSeccionsNumHabit_temp_data = capaUnidaSeccionsNumHabit_temp.dataProvider()
                attributes = capaUnidaSeccionsNumHabit.dataProvider().fields().toList()
                capaUnidaSeccionsNumHabit_temp_data.addAttributes(attributes)
                capaUnidaSeccionsNumHabit_temp.updateFields()
                capaUnidaSeccionsNumHabit_temp_data.addFeatures(capaUnidaSeccionsNumHabit_temp_features)
                if capaUnidaSeccionsNumHabit_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaSeccionsNumHabit_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de parcel de numhabit")

                seccionsDiagramNumHabit = QgsPieDiagram()
                seccionsDiagramNumHabitSettings = QgsDiagramSettings()
                seccionsDiagramNumHabitSettings.categoryColors = NumDiagramColors.values()
                seccionsDiagramNumHabitSettings.categoryAttributes = NumDiagramColors.keys()
                seccionsDiagramNumHabitSettings.scaleByArea = True
                seccionsDiagramNumHabitSettings.categoryLabels = seccionsDiagramNumHabitSettings.categoryAttributes

                seccionsDiagramNumHabitRenderer = QgsLinearlyInterpolatedDiagramRenderer()
                seccionsDiagramNumHabitRenderer.setLowerValue(0)
                seccionsDiagramNumHabitRenderer.setLowerSize(QSizeF(0, 0))
                seccionsDiagramNumHabitRenderer.setUpperValue(self.maxTotalEE(seccions))
                seccionsDiagramNumHabitRenderer.setUpperSize(QSizeF(30, 30))
                seccionsDiagramNumHabitRenderer.setClassificationField("TotalEE")
                seccionsDiagramNumHabitRenderer.setDiagram(seccionsDiagramNumHabit)
                seccionsDiagramNumHabitRenderer.setDiagramSettings(seccionsDiagramNumHabitSettings)
                
                capaUnidaSeccionsNumHabit_temp.setDiagramRenderer(seccionsDiagramNumHabitRenderer)
                seccionsDiagramNumHabitLayerSettings = QgsDiagramLayerSettings()

                capaUnidaSeccionsNumHabit_temp.setDiagramLayerSettings(seccionsDiagramNumHabitLayerSettings)
                capaUnidaSeccionsNumHabit_temp.triggerRepaint()
                QApplication.processEvents()

            if self.dlg.checkm2.isChecked():
                uri.setDataSource(schema1, f"Resum{seccions}Recomptem2", 'geom')
                capaUnidaSeccionsm2 = QgsVectorLayer(uri.uri(), f"Resum{seccions}Recomptem2", 'postgres')
                capaUnidaSeccionsm2_temp_features = [feat for feat in capaUnidaSeccionsm2.getFeatures()]
                capaUnidaSeccionsm2_temp = QgsVectorLayer("Polygon?crs=epsg:25831", f"Resum{seccions}Recomptem2", "memory")
                capaUnidaSeccionsm2_temp_data = capaUnidaSeccionsm2_temp.dataProvider()
                attributes = capaUnidaSeccionsm2.dataProvider().fields().toList()
                capaUnidaSeccionsm2_temp_data.addAttributes(attributes)
                capaUnidaSeccionsm2_temp.updateFields()
                capaUnidaSeccionsm2_temp_data.addFeatures(capaUnidaSeccionsm2_temp_features)
                if capaUnidaSeccionsm2_temp.isValid():
                    QgsProject.instance().addMapLayer(capaUnidaSeccionsm2_temp)
                    QApplication.processEvents()
                else:
                    print("No s'ha pogut afegir el layer de parcel de m2")

                seccionsDiagramm2 = QgsPieDiagram()
                seccionsDiagramm2Settings = QgsDiagramSettings()
                seccionsDiagramm2Settings.categoryColors = m2DiagramColors.values()
                seccionsDiagramm2Settings.categoryAttributes = m2DiagramColors.keys()
                seccionsDiagramm2Settings.scaleByArea = True
                seccionsDiagramm2Settings.categoryLabels = seccionsDiagramm2Settings.categoryAttributes

                seccionsDiagramm2Renderer = QgsLinearlyInterpolatedDiagramRenderer()
                seccionsDiagramm2Renderer.setLowerValue(0)
                seccionsDiagramm2Renderer.setLowerSize(QSizeF(0, 0))
                maxm2 = self.maxTotalm2(seccions)
                seccionsDiagramm2Renderer.setUpperValue(maxm2)
                seccionsDiagramm2Renderer.setUpperSize(QSizeF(30, 30))
                seccionsDiagramm2Renderer.setClassificationField("Totalm2")
                seccionsDiagramm2Renderer.setDiagram(seccionsDiagramm2)
                seccionsDiagramm2Renderer.setDiagramSettings(seccionsDiagramm2Settings)
                
                capaUnidaSeccionsm2_temp.setDiagramRenderer(seccionsDiagramm2Renderer)
                seccionsDiagramm2LayerSettings = QgsDiagramLayerSettings()

                capaUnidaSeccionsm2_temp.setDiagramLayerSettings(seccionsDiagramm2LayerSettings)
                capaUnidaSeccionsm2_temp.triggerRepaint()
                QApplication.processEvents()

        ''' Etiquetes de mitjana, mediana i moda '''

        label = QgsPalLayerSettings()
        label.enabled = True
        label.fieldName = """
        CASE
            WHEN "INDEX_consum" IS NOT NULL AND "INDEX_emissions" IS NOT NULL THEN concat('INDEX_consum: ', format_number("INDEX_consum", 2), ' KWh/m2any', '\nINDEX_emissions: ', format_number("INDEX_emissions", 2), ' KgCO2/m2any')
            WHEN "INDEX_consum" IS NOT NULL THEN concat('INDEX_consum: ', format_number("INDEX_consum", 2), ' KWh/m2any')
            WHEN "INDEX_emissions" IS NOT NULL THEN concat('INDEX_emissions: ', format_number("INDEX_emissions", 2), ' KgCO2/m2any')
            ELSE ''
        END
        """
        label.isExpression = True
        label.placement = QgsPalLayerSettings.AroundPoint

        if self.dlg.checkMitjana.isChecked():
            if self.dlg.checkParcel.isChecked():
                parcelLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(label))
                parcelLayerResumMitjana.setLabelsEnabled(True)
                parcelLayerResumMitjana.triggerRepaint()
                QgsProject.instance().addMapLayer(parcelLayerResumMitjana)
                QApplication.processEvents()

            if self.dlg.checkIlles.isChecked():
                illesLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(label))
                illesLayerResumMitjana.setLabelsEnabled(True)
                illesLayerResumMitjana.triggerRepaint()
                QgsProject.instance().addMapLayer(illesLayerResumMitjana)
                QApplication.processEvents()

            if self.dlg.checkDistrictes.isChecked():
                districtesLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(label))
                districtesLayerResumMitjana.setLabelsEnabled(True)
                districtesLayerResumMitjana.triggerRepaint()
                QgsProject.instance().addMapLayer(districtesLayerResumMitjana)
                QApplication.processEvents()
            
            if self.dlg.checkBarris.isChecked():
                barrisLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(label))
                barrisLayerResumMitjana.setLabelsEnabled(True)
                barrisLayerResumMitjana.triggerRepaint()
                QgsProject.instance().addMapLayer(barrisLayerResumMitjana)
                QApplication.processEvents()
            
            if self.dlg.checkSeccions.isChecked():
                seccionsLayerResumMitjana.setLabeling(QgsVectorLayerSimpleLabeling(label))
                seccionsLayerResumMitjana.setLabelsEnabled(True)
                seccionsLayerResumMitjana.triggerRepaint()
                QgsProject.instance().addMapLayer(seccionsLayerResumMitjana)
                QApplication.processEvents()
        
        labelModa = QgsPalLayerSettings()
        labelModa.enabled = True
        labelModa.fieldName = """
        CASE
            WHEN "QualifMaxSup" IS NOT NULL AND "indexMODAsup" IS NOT NULL AND "indexMODAsupPonderat" IS NOT NULL THEN 'Moda: ' || to_string("QualifMaxSup") || '\nindexMODAsup: ' || format_number("indexMODAsup", 2) || ' KWh/m2any' || '\nindexMODAsupPonderat: ' || format_number("indexMODAsupPonderat", 2) || ' KWh/m2any'
            WHEN "QualifMaxSup" IS NOT NULL AND "indexMODAsup" IS NOT NULL THEN 'Moda: ' || to_string("QualifMaxSup") || '\nindexMODAsup: ' || format_number("indexMODAsup", 2) || ' KWh/m2any'
            WHEN "QualifMaxSup" IS NOT NULL AND "indexMODAsupPonderat" IS NOT NULL THEN 'Moda: ' || to_string("QualifMaxSup") || '\nindexMODAsupPonderat: ' || format_number("indexMODAsupPonderat", 2) || ' KWh/m2any'
            WHEN "indexMODAsup" IS NOT NULL AND "indexMODAsupPonderat" IS NOT NULL THEN 'indexMODAsup: ' || format_number("indexMODAsup", 2) || ' KWh/m2any' || '\nindexMODAsupPonderat: ' || format_number("indexMODAsupPonderat", 2) || ' KWh/m2any'
            WHEN "QualifMaxSup" IS NOT NULL THEN 'Moda: ' || to_string("QualifMaxSup")
            WHEN "indexMODAsup" IS NOT NULL THEN 'indexMODAsup: ' || format_number("indexMODAsup", 2) || ' KWh/m2any'
            WHEN "indexMODAsupPonderat" IS NOT NULL THEN 'indexMODAsupPonderat: ' || format_number("indexMODAsupPonderat", 2) || ' KWh/m2any'
            ELSE ''
        END
        """

        
        labelModa.isExpression = True
        labelModa.placement = QgsPalLayerSettings.AroundPoint
        
        if self.dlg.checkModa.isChecked():
            if self.dlg.checkParcel.isChecked():
                parcelLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
                parcelLayerResumModa.setLabelsEnabled(True)
                parcelLayerResumModa.triggerRepaint()
                QgsProject.instance().addMapLayer(parcelLayerResumModa)
                QApplication.processEvents()
            if self.dlg.checkIlles.isChecked():
                illesLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
                illesLayerResumModa.setLabelsEnabled(True)
                illesLayerResumModa.triggerRepaint()
                QgsProject.instance().addMapLayer(illesLayerResumModa)
                QApplication.processEvents()
            if self.dlg.checkBarris.isChecked():
                barrisLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
                barrisLayerResumModa.setLabelsEnabled(True)
                barrisLayerResumModa.triggerRepaint()
                QgsProject.instance().addMapLayer(barrisLayerResumModa)
                QApplication.processEvents()
            if self.dlg.checkDistrictes.isChecked():
                districtesLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
                districtesLayerResumModa.setLabelsEnabled(True)
                districtesLayerResumModa.triggerRepaint()
                QgsProject.instance().addMapLayer(districtesLayerResumModa)
                QApplication.processEvents()
            if self.dlg.checkSeccions.isChecked():
                seccionsLayerResumModa.setLabeling(QgsVectorLayerSimpleLabeling(labelModa))
                seccionsLayerResumModa.setLabelsEnabled(True)
                seccionsLayerResumModa.triggerRepaint()
                QgsProject.instance().addMapLayer(seccionsLayerResumModa)
                QApplication.processEvents()
            
        labelMediana = QgsPalLayerSettings()
        labelMediana.enabled = True
        labelMediana.fieldName = """
        CASE
            WHEN "INDEX_mediana_consum" IS NOT NULL AND "INDEX_mediana_emissions" IS NOT NULL THEN concat('INDEX_mediana_consum: ', format_number("INDEX_mediana_consum", 2), ' KWh/m2any', '\nINDEX_mediana_emissions: ', format_number("INDEX_mediana_emissions", 2), ' KgCO2/m2any')
            WHEN "INDEX_mediana_consum" IS NOT NULL THEN concat('INDEX_mediana_consum: ', format_number("INDEX_mediana_consum", 2), ' KWh/m2any')
            WHEN "INDEX_mediana_emissions" IS NOT NULL THEN concat('INDEX_mediana_emissions: ', format_number("INDEX_mediana_emissions", 2), ' KgCO2/m2any')
            ELSE ''
        END
        """
        labelMediana.isExpression = True
        labelMediana.placement = QgsPalLayerSettings.AroundPoint

        if self.dlg.checkMediana.isChecked():
            if self.dlg.checkParcel.isChecked():
                parcelLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
                parcelLayerResumMediana.setLabelsEnabled(True)
                parcelLayerResumMediana.triggerRepaint()
                QgsProject.instance().addMapLayer(parcelLayerResumMediana)
                QApplication.processEvents()
            if self.dlg.checkIlles.isChecked():
                illesLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
                illesLayerResumMediana.setLabelsEnabled(True)
                illesLayerResumMediana.triggerRepaint()
                QgsProject.instance().addMapLayer(illesLayerResumMediana)
                QApplication.processEvents()
            if self.dlg.checkBarris.isChecked():
                barrisLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
                barrisLayerResumMediana.setLabelsEnabled(True)
                barrisLayerResumMediana.triggerRepaint()
                QgsProject.instance().addMapLayer(barrisLayerResumMediana)
                QApplication.processEvents()
            if self.dlg.checkDistrictes.isChecked():
                districtesLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
                districtesLayerResumMediana.setLabelsEnabled(True)
                districtesLayerResumMediana.triggerRepaint()
                QgsProject.instance().addMapLayer(districtesLayerResumMediana)
                QApplication.processEvents()
            if self.dlg.checkSeccions.isChecked():
                seccionsLayerResumMediana.setLabeling(QgsVectorLayerSimpleLabeling(labelMediana))
                seccionsLayerResumMediana.setLabelsEnabled(True)
                seccionsLayerResumMediana.triggerRepaint()
                QgsProject.instance().addMapLayer(seccionsLayerResumMediana)
                QApplication.processEvents()

        self.dropFinalCapesIColumnes()
        textBox += f"PROCÉS FINALITZAT!\n"
        self.dlg.textEstat.setText(textBox)
        self.dlg.setEnabled(True)
        self.dlg.groupBD.setEnabled(True)
        self.dlg.groupChecks.setEnabled(True)
        self.dlg.groupEntitats.setEnabled(True)
        cur.close()
        conn.close()
        self.estatFinalitzat()
        QApplication.processEvents()

    def populateComboBox(self, combo, list, predef, sort):
        """Procediment per omplir el combo especificat amb la llista subministrada"""
        combo.blockSignals(True)
        combo.clear()
        model = QStandardItemModel(combo)
        predefInList = None
        for elem in list:
            try:
                item = QStandardItem(str(elem))
            except TypeError:
                item = QStandardItem(str(elem))
            model.appendRow(item)
            if elem == predef:
                predefInList = elem
        if sort:
            model.sort(0)
        combo.setModel(model)
        if predef != "":
            if predefInList:
                combo.setCurrentIndex(combo.findText(predefInList))
            else:
                combo.insertItem(0, predef)
                combo.setCurrentIndex(0)
        combo.blockSignals(False)

    def unload(self):
        """Removes the plugin menu item and icon from QGIS GUI."""
        for action in self.actions:
            self.iface.removePluginMenu(
                self.tr(u'&Eficiència Energetica'),
                action)
            self.iface.removeToolBarIcon(action)

    def run(self):
        """Run method that performs all the real work"""
        # show the dialog
        self.estatInicial()
        self.dlg.show()
        conn=self.getConnections()
        # Run the dialog event loop
        self.populateComboBox(self.dlg.comboBD, conn, 'Selecciona connexió', True)
        result = self.dlg.exec_()
        # See if OK was pressed
        if result:
            # Do something useful here - delete the line containing pass and
            # substitute with your code.
            pass
